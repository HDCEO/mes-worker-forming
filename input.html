<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES 작업자 입력 - 포밍반</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: #1e3a8a; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2563eb; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .hidden { display: none !important; }
        .work-item { padding: 15px; margin: 10px 0; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; }
        .work-item:hover { border-color: #3b82f6; }
        .work-item.selected { border-color: #3b82f6; background: #dbeafe; }
        select, input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .kpi-item { text-align: center; padding: 15px; background: #f9fafb; border-radius: 6px; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #1e3a8a; }
        .defect-list { margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; }
        .defect-item { padding: 5px; border-bottom: 1px solid #e5e7eb; }
        
        /* 작업 가이드 섹션 스타일 */
        .work-guide-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .work-guide-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 600;
        }
        
        .guide-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .guide-icon {
            font-size: 20px;
        }
        
        .recommended-work {
            color: #1e40af;
            font-weight: bold;
        }
        
        .delivery-countdown {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .delivery-countdown.urgent {
            background: #fee2e2;
            color: #991b1b;
            animation: urgentPulse 2s infinite;
        }
        
        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* 작업 목록 우선순위 스타일 개선 */
        .work-item {
            position: relative;
            padding: 15px;
            margin: 10px 0;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .work-item:hover {
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .work-item.selected {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            animation: selectedPulse 2s infinite;
            position: relative;
            z-index: 10;
        }
        
        @keyframes selectedPulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
            }
        }
        
        .work-item.selected::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #3b82f6, #1d4ed8, #3b82f6);
            border-radius: 12px;
            z-index: -1;
            animation: borderGlow 2s linear infinite;
        }
        
        @keyframes borderGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .selected-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            animation: checkboxPop 0.3s ease-out;
        }
        
        @keyframes checkboxPop {
            0% { 
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.2) rotate(90deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .selected-label {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            animation: labelSlideDown 0.4s ease-out;
        }
        
        @keyframes labelSlideDown {
            0% { 
                transform: translateX(-50%) translateY(-10px);
                opacity: 0;
            }
            100% { 
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .work-item.urgent {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 6px solid #ef4444;
        }
        
        .work-item.priority {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 6px solid #f59e0b;
        }
        
        .work-item.normal {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 6px solid #10b981;
        }
        
        .work-item.low {
            border-color: #6b7280;
            background: #f9fafb;
            opacity: 0.8;
        }
        
        .work-order-badge {
            position: absolute;
            top: -8px;
            left: 15px;
            background: #1e40af;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .work-order-badge.first {
            background: #ef4444;
            animation: recommendedWork 2s infinite;
        }
        
        .work-order-badge.second {
            background: #f59e0b;
        }
        
        .work-order-badge.third {
            background: #10b981;
        }
        
        @keyframes recommendedWork {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .work-priority-icons {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .priority-icon {
            font-size: 16px;
        }
        
        .delivery-info {
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #374151;
            margin-top: 5px;
        }
        
        .delivery-info.urgent {
            background: #fee2e2;
            color: #991b1b;
            font-weight: bold;
        }
        
        .delivery-info.today {
            background: #fef3c7;
            color: #92400e;
            font-weight: bold;
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .notification-list {
            margin-top: 8px;
            padding: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            border-left: 3px solid #3b82f6;
        }
        
        .notification-item {
            font-size: 11px;
            color: #1e40af;
            margin-bottom: 2px;
        }
        
        .notification-item:last-child {
            margin-bottom: 0;
        }
        
        /* 실시간 알림 토스트 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideIn 0.3s ease-out forwards;
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(100%);
            }
        }
        
        .toast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .toast-icon {
            font-size: 16px;
        }
        
        /* 개선된 불량 관리 스타일 */
        .defect-alert-section {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .defect-alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .defect-alert-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #991b1b;
            font-weight: 600;
        }
        
        .emergency-defect-btn {
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
            animation: defectPulse 2s infinite;
        }
        
        .emergency-defect-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4);
        }
        
        @keyframes defectPulse {
            0%, 100% { box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 4px 8px rgba(239, 68, 68, 0.6); }
        }
        
        .defect-analysis-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .work-context-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .work-context-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0f2fe;
        }
        
        .context-label {
            font-weight: 600;
            color: #0c4a6e;
        }
        
        .context-value {
            color: #374151;
            font-weight: 500;
        }
        
        .defect-analysis-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .analysis-step {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: #f9fafb;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .step-number {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .step-title {
            font-weight: 600;
            color: #374151;
        }
        
        .analysis-step.completed .step-number {
            background: #10b981;
        }
        
        .analysis-step.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .defect-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .defect-type-btn {
            padding: 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }
        
        .defect-type-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .defect-type-btn.selected {
            border-color: #3b82f6;
            background: #dbeafe;
            font-weight: 600;
        }
        
        .cause-analysis-tree {
            margin-top: 15px;
        }
        
        .cause-category {
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .cause-header {
            background: #f3f4f6;
            padding: 12px 15px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cause-list {
            padding: 10px;
            background: white;
            display: none;
        }
        
        .cause-list.active {
            display: block;
        }
        
        .cause-item {
            padding: 8px 12px;
            margin: 4px 0;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cause-item:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .cause-item.selected {
            border-color: #f59e0b;
            background: #fef3c7;
            font-weight: 600;
        }
        
        .action-plan-section {
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .action-grid {
            display: grid;
            gap: 15px;
            margin-top: 10px;
        }
        
        .defect-history-section {
            background: #fefce8;
            border: 1px solid #eab308;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .history-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .history-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .history-badge.resolved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .defect-impact-alert {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .impact-level {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .impact-level.high {
            color: #ef4444;
        }
        
        .impact-level.medium {
            color: #f59e0b;
        }
        
        .impact-level.low {
            color: #10b981;
        }
        .safety-status-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .safety-status-content {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        .safety-status-content .safety-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .safety-days {
            padding: 4px 12px;
            border-radius: 20px;
            margin: 0 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        /* 안전 일수별 색상 */
        .safety-days.level-1 { background: #f3f4f6; color: #6b7280; } /* 30일 미만 - 회색 */
        .safety-days.level-2 { background: #fef3c7; color: #92400e; } /* 30-99일 - 주황 */
        .safety-days.level-3 { background: #d1fae5; color: #065f46; } /* 100-199일 - 초록 */
        .safety-days.level-4 { background: #dbeafe; color: #1e40af; } /* 200일+ - 파랑 */
        
        .safety-divider {
            color: #6b7280;
            margin: 0 8px;
        }
        
        .safety-average, .safety-record {
            font-size: 16px;
            color: #374151;
        }
        
        /* 2인 작업 관련 스타일 */
        .two-person-work { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .worker-info-container { display: flex; flex-direction: column; gap: 5px; }
        .sub-worker-section { margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 6px; border: 1px solid #0ea5e9; }
        .worker-badge { display: inline-block; padding: 2px 8px; margin: 2px; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 12px; }
        .main-worker { background: #dcfce7; color: #166534; }
        .sub-worker { background: #fef3c7; color: #92400e; }
        
        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* 체크박스 스타일 */
        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .checkbox-item:hover {
            background: #f3f4f6;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        /* 초품검사 스타일 */
        .inspection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .product-inspection {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .product-inspection.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .product-inspection.failed {
            border-color: #ef4444;
            background: #fef2f2;
            animation: failureShake 0.5s ease-in-out;
        }

        @keyframes failureShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .inspection-items {
            margin: 15px 0;
        }

        .inspection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .inspection-label {
            font-weight: 500;
            color: #374151;
        }

        .inspection-buttons {
            display: flex;
            gap: 5px;
        }

        .inspection-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inspection-btn.pass {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #10b981;
        }

        .inspection-btn.pass.selected {
            background: #10b981;
            color: white;
        }

        .inspection-btn.fail {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .inspection-btn.fail.selected {
            background: #ef4444;
            color: white;
        }

        .product-criteria {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
            text-align: left;
        }

        .inspection-progress {
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            color: #1e3a8a;
        }

        .inspection-warning {
            background: #fef2f2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .inspection-failed-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .inspection-failed-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .failed-icon {
            font-size: 48px;
            color: #ef4444;
            margin-bottom: 15px;
        }

        .failed-title {
            font-size: 24px;
            font-weight: bold;
            color: #ef4444;
            margin-bottom: 15px;
        }

        .failed-result {
            background: #fef2f2;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ef4444;
        }

        .failed-actions {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }

        .failed-actions h4 {
            color: #374151;
            margin-bottom: 10px;
        }

        .failed-actions ul {
            color: #6b7280;
            padding-left: 20px;
        }

        .failed-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-retry {
            background: #f59e0b;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-retry:hover {
            background: #d97706;
        }

        .btn-maintenance {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-maintenance:hover {
            background: #4b5563;
        }

        .retry-count-warning {
            background: #fbbf24;
            color: #92400e;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }

        /* 안전 관련 스타일 */
        .safety-section {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .emergency-button {
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
            animation: emergencyPulse 2s infinite;
        }

        .emergency-button:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4);
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 4px 8px rgba(239, 68, 68, 0.6); }
        }

        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .emergency-item {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
        }

        .emergency-item:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.05);
        }

        .emergency-item .icon {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .safety-checklist-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .safety-checklist-group h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div id="loginScreen" class="container">
        <div class="header">
            <h1>포밍반 작업자 로그인</h1>
        </div>
        <div class="section">
            <h2>작업자 정보 입력</h2>
            <br>
            <label>주작업자 이름:</label>
            <select id="workerName">
                <option value="">선택하세요</option>
                <option value="김철수">김철수</option>
                <option value="이영희">이영희</option>
                <option value="박민수">박민수</option>
                <option value="김수정">김수정</option>
                <option value="이철수">이철수</option>
                <option value="박영희">박영희</option>
                <option value="최민호">최민호</option>
                <option value="정대현">정대현</option>
                <option value="강미영">강미영</option>
                <option value="홍길동">홍길동</option>
            </select>
            
            <br><br>
            <label>작업 호기:</label>
            <select id="machineNo">
                <option value="">선택하세요</option>
                <option value="1">1호기</option>
                <option value="2">2호기</option>
                <option value="3">3호기</option>
            </select>
            
            <!-- 2인 작업 섹션 -->
            <div class="sub-worker-section">
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="twoPersonWork" style="width: auto; margin-right: 10px;" onchange="toggleSubWorker()">
                    <span style="font-weight: bold;">2인 작업 (대형 제품)</span>
                </label>
                
                <div id="subWorkerSection" style="display: none;">
                    <label>보조작업자 선택:</label>
                    <div id="subWorkerList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-top: 5px;">
                        <!-- 보조작업자 체크박스 목록이 여기에 생성됨 -->
                    </div>
                    <div id="selectedSubWorkers" style="margin-top: 10px; font-size: 14px; color: #666;">
                        선택된 보조작업자: 없음
                    </div>
                </div>
            </div>
            
            <br><br>
            <button class="btn" onclick="doLogin()">로그인</button>
        </div>
    </div>

    <!-- 메인 화면 -->
    <div id="mainScreen" class="container hidden">
        <div class="header">
            <h1>포밍반 작업 입력</h1>
            <div class="worker-info-container">
                <div id="workerInfo"></div>
                <div id="subWorkerInfo" style="font-size: 14px; color: #e5e7eb;"></div>
            </div>
            <div>현재 시간: <span id="currentTime"></span></div>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn" onclick="logout()" style="padding: 5px 15px; font-size: 14px; background: #6b7280;">로그아웃</button>
                <button class="emergency-button" onclick="showEmergencyModal()">🚨 긴급상황</button>
            </div>
        </div>
        
        <!-- 안전 현황 섹션 -->
        <div class="safety-status-section">
            <div class="safety-status-content">
                <span class="safety-icon">🛡️</span>
                <span>안전 현황:</span>
                <span class="safety-days" id="currentLineSafety">3호기 127일 무사고</span>
                <span class="safety-divider">|</span>
                <span class="safety-average">전체 평균 <span id="averageSafety">98</span>일</span>
                <span class="safety-divider">|</span>
                <span class="safety-record">최고기록 <span id="recordSafety">245</span>일</span>
            </div>
        </div>
        
        <!-- 불량 발생 알림 섹션 (작업 중에만 표시) -->
        <div class="defect-alert-section" id="defectAlertSection">
            <div class="defect-alert-content">
                <div class="defect-alert-info">
                    <span style="font-size: 20px;">🚨</span>
                    <span>불량 발견 시 즉시 신고하세요!</span>
                </div>
                <button class="emergency-defect-btn" onclick="showDefectAnalysisModal()">
                    🚨 긴급 불량 신고
                </button>
            </div>
        </div>
        <div class="work-guide-section">
            <div class="work-guide-content">
                <div class="guide-main">
                    <span class="guide-icon">📍</span>
                    <span>다음 권장 작업:</span>
                    <span class="recommended-work" id="recommendedWork">작업을 선택하세요</span>
                </div>
                <div class="delivery-countdown" id="deliveryCountdown">-</div>
            </div>
        </div>
        
        <!-- KPI 섹션 -->
        <div class="section">
            <h2>실시간 현황</h2>
            <div class="kpi-grid">
                <div class="kpi-item">
                    <div>총 생산량</div>
                    <div class="kpi-value" id="totalProduction">0m</div>
                </div>
                <div class="kpi-item">
                    <div>달성률</div>
                    <div class="kpi-value" id="achievementRate">0%</div>
                </div>
                <div class="kpi-item">
                    <div>불량률</div>
                    <div class="kpi-value" id="defectRate">0%</div>
                </div>
                <div class="kpi-item">
                    <div>작업 시간</div>
                    <div class="kpi-value" id="workTime">00:00</div>
                </div>
            </div>
        </div>
        
        <!-- 작업 제어 -->
        <div class="section">
            <h2>작업 제어</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <button class="btn btn-success" id="startBtn" onclick="startWork()" disabled>▶️ 작업 시작</button>
                <button class="btn btn-danger" id="stopBtn" onclick="showStopModal()" disabled>⏸️ 설비 정지</button>
                <button class="btn btn-warning" id="pauseBtn" onclick="showPauseWorkModal()" disabled>⏸️ 작업 중단</button>
                <button class="btn" id="resumeBtn" onclick="resumeWork()" disabled>▶️ 작업 재개</button>
                <button class="btn btn-success" id="resumeWorkBtn" onclick="resumePausedWork()" disabled>▶️ 이어서 작업</button>
                <button class="btn" id="endBtn" onclick="showEndWorkModal()" disabled style="background: #6b7280;">⏹️ 작업 종료</button>
            </div>
            <div id="currentWork" style="margin-top: 10px; font-weight: bold; text-align: center;"></div>
            <div id="previousProduction" style="margin-top: 5px; color: #3b82f6; text-align: center;"></div>
        </div>
        
        <!-- 작업 목록 -->
        <div class="section">
            <h2>작업 목록 <span style="font-size: 14px; color: #666;">(스마트 정렬 적용)</span></h2>
            <div id="workList"></div>
        </div>
        
        <!-- 실시간 알림 컨테이너 -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- 불량 기록 -->
        <div class="section">
            <h2>불량 관리 <span style="font-size: 14px; color: #666;">(고도화된 추적 시스템)</span></h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>불량 수량 (m):</label>
                    <input type="number" id="defectQty" placeholder="0" step="0.1">
                    <label>불량 유형:</label>
                    <select id="defectType">
                        <option value="">선택</option>
                        <option value="surface">표면불량</option>
                        <option value="dimension">치수불량</option>
                        <option value="deformation">변형</option>
                        <option value="foreign">이물질</option>
                        <option value="other">기타</option>
                    </select>
                    <br><br>
                    <button class="btn" onclick="saveDefect()">일반 불량 저장</button>
                    <button class="btn" onclick="showDefectAnalysisModal()" style="background: #ef4444; margin-left: 10px;">🔍 상세 분석</button>
                </div>
                
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: #374151;">💡 불량 관리 가이드</h4>
                    <ul style="font-size: 13px; color: #6b7280; line-height: 1.6;">
                        <li><strong>일반 불량</strong>: 단순 기록용</li>
                        <li><strong>상세 분석</strong>: 원인 추적 및 개선 필요 시</li>
                        <li><strong>긴급 신고</strong>: 작업 중 즉시 대응 필요 시</li>
                        <li>연속 불량 발생 시 자동 알림</li>
                    </ul>
                </div>
            </div>
            
            <div class="defect-list">
                <h3>오늘의 불량 기록 <span id="defectSummary" style="font-size: 14px; color: #666;"></span></h3>
                <div id="defectList">아직 기록된 불량이 없습니다.</div>
            </div>
        </div>
        
        <!-- 설비 정지 관리 (통합) -->
        <div class="section">
            <h2>설비 정지 관리</h2>
            <button class="btn btn-danger" id="independentStopBtn" onclick="showIndependentStopModal()">⏸️ 설비 정지 기록</button>
            <button class="btn" id="independentResumeBtn" onclick="independentResume()" disabled>▶️ 설비 재가동</button>
            <div id="independentStopStatus" style="margin-top: 10px; color: #ef4444; font-weight: bold;"></div>
            <div id="independentStopTime" style="font-size: 20px; color: #ef4444; font-weight: bold;"></div>
            
            <div class="defect-list">
                <h3>설비 정지 기록</h3>
                <div id="stopLogList">아직 설비 정지 기록이 없습니다.</div>
            </div>
        </div>
    </div>
    
    <!-- 시작 점검 모달 (확장된 버전) -->
    <div id="checklistModal" class="modal hidden">
        <div class="modal-content">
            <h2>🔧 작업 시작 전 종합점검</h2>
            <p style="color: #666; font-size: 14px; margin: 10px 0;">
                작업지시서 <strong id="checklistWorkNo"></strong> - 안전한 작업을 위해 다음 항목을 확인하세요.
            </p>
            
            <div class="safety-checklist-group">
                <h4>🏭 설비 관련</h4>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="check1" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">설비 이상 없음</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="check2" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">금형 상태 정상</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="check3" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">원자재(코일) 준비 완료</span>
                </label>
            </div>

            <div class="safety-checklist-group">
                <h4>🛡️ 안전 관련</h4>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="check4" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">안전장비 착용 (안전모, 안전화, 작업복)</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="check7" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">작업구역 안전상태 확인</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="check8" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;" id="workSpecificSafety">이 작업의 특정 안전사항 확인</span>
                </label>
            </div>

            <div class="safety-checklist-group">
                <h4>📋 작업 관련</h4>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="check5" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">작업지시서 확인</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="check6" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">인수인계 사항 확인</span>
                </label>
            </div>
            
            <br>
            <button class="btn btn-success" id="checklistConfirmBtn" onclick="confirmChecklist()" disabled style="width: 100%; padding: 15px;">모든 항목 확인 완료</button>
            <button class="btn" style="background: #6b7280; width: 100%; padding: 10px; margin-top: 10px;" onclick="skipChecklist()">건너뛰기</button>
        </div>
    </div>
    
    <!-- 초품검사 모달 (개선된 버전) -->
    <div id="firstProductModal" class="modal hidden">
        <div class="modal-content">
            <h2>🔍 초품검사 (필수)</h2>
            <p style="color: #666; font-size: 14px; margin: 10px 0;">
                작업지시서 <strong id="inspectionWorkNo"></strong> - <strong id="inspectionProduct"></strong>
            </p>
            <div style="background: #fef3c7; color: #92400e; padding: 10px; border-radius: 4px; margin: 10px 0;">
                ⚠️ 첫 3개 제품을 검사해야 작업을 시작할 수 있습니다.
            </div>
            
            <div id="inspectionWarningArea"></div>
            
            <div class="inspection-progress" id="inspectionProgress">
                검사 진행률: 0/3 완료
            </div>
            
            <div class="inspection-grid" id="inspectionGrid">
                <!-- 3개 제품 검사 카드가 여기에 생성됨 -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" id="completeInspectionBtn" onclick="completeInspection()" disabled>
                    ✅ 검사 완료 - 작업 시작
                </button>
            </div>
        </div>
    </div>

    <!-- 초품검사 실패 모달 -->
    <div id="inspectionFailedModal" class="inspection-failed-modal hidden">
        <div class="inspection-failed-content">
            <div class="failed-icon">🚫</div>
            <div class="failed-title">초품검사 불합격</div>
            
            <div class="failed-result">
                <div><strong>검사 결과:</strong></div>
                <div id="failedResultText">합격 0개, 불합격 0개</div>
            </div>
            
            <div style="background: #fef2f2; color: #991b1b; padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold;">
                ⚠️ 품질 기준 미달로 인해<br>작업을 시작할 수 없습니다.
            </div>
            
            <div class="failed-actions">
                <h4>📋 필요한 조치:</h4>
                <ul>
                    <li>설비 상태 점검</li>
                    <li>금형 조정</li>
                    <li>원자재 확인</li>
                    <li>작업 조건 재설정</li>
                </ul>
            </div>
            
            <div id="retryWarning" class="retry-count-warning hidden">
                ⚠️ 재검사 <span id="retryCount">0</span>회 실시됨 (3회 초과 시 관리자 호출)
            </div>
            
            <div class="failed-buttons">
                <button class="btn-retry" onclick="retryInspection()">
                    🔄 재검사 실시
                </button>
                <button class="btn-maintenance" onclick="requestMaintenance()">
                    📞 설비점검 요청
                </button>
            </div>
        </div>
    </div>

    <!-- 설비 정지 모달 -->
    <div id="stopModal" class="modal hidden">
        <div class="modal-content">
            <h2>설비 정지 사유</h2>
            <br>
            <label>정지 사유를 선택하세요:</label>
            <select id="stopReason">
                <option value="">선택하세요</option>
                <option value="coil_change">코일준비교체</option>
                <option value="bending_pack">밴딩포장</option>
                <option value="equipment_failure">설비고장</option>
                <option value="mold_change">금형교체</option>
                <option value="material_shortage">자재부족</option>
                <option value="maintenance">정기점검</option>
                <option value="other">기타</option>
            </select>
            <br><br>
            <button class="btn btn-danger" onclick="confirmStop()">확인</button>
            <button class="btn" onclick="cancelStop()">취소</button>
        </div>
    </div>
    
    <!-- 작업 종료 모달 -->
    <div id="endWorkModal" class="modal hidden">
        <div class="modal-content">
            <h2>작업 종료</h2>
            <br>
            <label>양품 수량 (m):</label>
            <input type="number" id="goodQty" placeholder="0" step="0.1">
            <br><br>
            <button class="btn btn-success" onclick="confirmEndWork()">확인</button>
            <button class="btn" onclick="cancelEndWork()">취소</button>
        </div>
    </div>

    <!-- 작업 중단 모달 -->
    <div id="pauseWorkModal" class="modal hidden">
        <div class="modal-content">
            <h2>작업 중단</h2>
            <br>
            <label>현재까지 생산량 (m):</label>
            <input type="number" id="pauseQty" placeholder="0" step="0.1">
            <br><br>
            <label>중단 사유:</label>
            <select id="pauseReason">
                <option value="">선택하세요</option>
                <option value="worker_change">작업자 교대</option>
                <option value="urgent_order">긴급 작업</option>
                <option value="meal_time">식사 시간</option>
                <option value="material_shortage">자재 부족</option>
                <option value="quality_issue">품질 문제</option>
                <option value="other">기타</option>
            </select>
            <br><br>
            <label>인수인계 메모 (선택사항):</label>
            <textarea id="pauseMemo" placeholder="다음 작업자에게 전달할 내용을 입력하세요." 
                      style="height: 80px; resize: vertical;"></textarea>
            <br><br>
            <button class="btn btn-warning" onclick="confirmPauseWork()">확인</button>
            <button class="btn" onclick="cancelPauseWork()">취소</button>
        </div>
    </div>

    <!-- 독립 설비 정지 모달 -->
    <div id="independentStopModal" class="modal hidden">
        <div class="modal-content">
            <h2>설비 정지 사유 (작업 외)</h2>
            <br>
            <label>정지 사유를 선택하세요:</label>
            <select id="independentStopReason">
                <option value="">선택하세요</option>
                <option value="coil_change">코일준비교체</option>
                <option value="bending_pack">밴딩포장</option>
                <option value="equipment_failure">설비고장</option>
                <option value="mold_change">금형교체</option>
                <option value="material_shortage">자재부족</option>
                <option value="maintenance">정기점검</option>
                <option value="break">휴식시간</option>
                <option value="meeting">회의/교육</option>
                <option value="other">기타</option>
            </select>
            <br><br>
            <button class="btn btn-danger" onclick="confirmIndependentStop()">확인</button>
            <button class="btn" onclick="cancelIndependentStop()">취소</button>
        </div>
    </div>

    <!-- 실적 수정 모달 -->
    <div id="correctionModal" class="modal hidden">
        <div class="modal-content">
            <h2>📝 실적 수정</h2>
            <br>
            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <div><strong>작업:</strong> <span id="correctionWorkName"></span></div>
                <div><strong>현재 기록:</strong> <span id="correctionCurrentQty"></span>m</div>
            </div>
            
            <label>수정량 (+ 또는 - 입력):</label>
            <input type="number" id="correctionAdjustQty" placeholder="예: +10 또는 -5" step="0.1">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                양수(+)는 증가, 음수(-)는 감소를 의미합니다.
            </div>
            
            <br>
            <label>수정 사유:</label>
            <select id="correctionReason">
                <option value="">선택하세요</option>
                <option value="측정 오류">측정 오류</option>
                <option value="계산 실수">계산 실수</option>
                <option value="누락된 수량">누락된 수량</option>
                <option value="중복 기록">중복 기록</option>
                <option value="기타">기타</option>
            </select>
            
            <div id="correctionPreview" style="margin: 15px 0; padding: 10px; background: #e0f2fe; border-radius: 4px; display: none;">
                <strong>수정 결과 미리보기:</strong>
                <div id="correctionPreviewText"></div>
            </div>
            
            <br><br>
            <button class="btn btn-success" onclick="confirmCorrection()">수정 완료</button>
            <button class="btn" onclick="cancelCorrection()">취소</button>
        </div>
    </div>

    <!-- LOT 번호 입력 모달 -->
    <div id="lotModal" class="modal hidden">
        <div class="modal-content">
            <h2>작업 시작 정보 입력</h2>
            <p style="color: #666; font-size: 14px; margin: 10px 0;">작업에 필요한 정보를 입력하세요.</p>
            <br>
            
            <label>코일 LOT 번호:</label>
            <select id="lotSelect" style="width: 100%; padding: 10px; margin: 10px 0;" onchange="handleLotSelect()">
                <option value="">선택하세요</option>
                <option value="20250122-HY-001">20250122-HY-001 (현대제철)</option>
                <option value="20250122-PO-001">20250122-PO-001 (포스코)</option>
                <option value="20250121-HY-003">20250121-HY-003 (현대제철)</option>
                <option value="manual">직접 입력...</option>
            </select>
            
            <div id="manualLotInput" style="display: none;">
                <label>LOT 번호 직접 입력:</label>
                <input type="text" id="manualLot" placeholder="예: 20250122-HY-001" style="width: 100%; padding: 10px; margin: 10px 0;">
            </div>
            
            <label style="margin-top: 15px; display: block;">금형 번호:</label>
            <select id="moldSelect" style="width: 100%; padding: 10px; margin: 10px 0;" onchange="handleMoldSelect()">
                <option value="">선택하세요</option>
                <option value="MBAR-001-4CAV">MBAR-001-4CAV (M-BAR 4캐비티)</option>
                <option value="MBAR-002-4CAV">MBAR-002-4CAV (M-BAR 4캐비티)</option>
                <option value="RUN30-001-2CAV">RUN30-001-2CAV (RUNNER 30 2캐비티)</option>
                <option value="RUN30-002-2CAV">RUN30-002-2CAV (RUNNER 30 2캐비티)</option>
                <option value="STUD-001-6CAV">STUD-001-6CAV (STUD 6캐비티)</option>
                <option value="manual">직접 입력...</option>
            </select>
            
            <div id="manualMoldInput" style="display: none;">
                <label>금형 번호 직접 입력:</label>
                <input type="text" id="manualMold" placeholder="예: MBAR-001-4CAV" style="width: 100%; padding: 10px; margin: 10px 0;">
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="sameLotCheck" onclick="handleSameLot()" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">이전과 동일한 설정 사용</span>
                </label>
                <div id="previousInfo" style="font-size: 14px; margin-top: 5px; display: none;">
                    <div id="previousLotInfo" style="color: #3b82f6;"></div>
                    <div id="previousMoldInfo" style="color: #3b82f6;"></div>
                </div>
            </div>
            
            <br>
            <button class="btn btn-success" onclick="confirmLot()">확인</button>
            <button class="btn" onclick="cancelLot()">취소</button>
        </div>
    </div>

    <!-- 일일 안전점검 모달 -->
    <div id="dailySafetyModal" class="modal hidden">
        <div class="modal-content">
            <h2>🛡️ 일일 안전점검 (필수)</h2>
            <p style="color: #666; font-size: 14px; margin: 10px 0;">
                안전한 작업환경을 위해 다음 항목을 확인해주세요.
            </p>
            <div style="background: #fef2f2; color: #991b1b; padding: 10px; border-radius: 4px; margin: 10px 0;">
                ⚠️ 모든 항목을 확인해야 작업을 시작할 수 있습니다.
            </div>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 6px;">
                <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
                    <input type="checkbox" id="safetyCheck1" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">🚪 비상구 위치 및 경로 확인</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
                    <input type="checkbox" id="safetyCheck2" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">🧯 소화기 위치 및 상태 확인</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
                    <input type="checkbox" id="safetyCheck3" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">🧹 작업구역 정리정돈 상태 확인</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="safetyCheck4" style="margin-right: 10px; width: 18px; height: 18px;">
                    <span style="text-align: left;">🔒 위험물질 보관함 잠금 확인</span>
                </label>
            </div>
            
            <br>
            <button class="btn btn-success" id="dailySafetyConfirmBtn" onclick="confirmDailySafety()" disabled style="width: 100%; padding: 15px;">
                ✅ 안전점검 완료
            </button>
        </div>
    </div>

    <!-- 불량 상세 분석 모달 -->
    <div id="defectAnalysisModal" class="modal hidden">
        <div class="modal-content defect-analysis-modal">
            <h2>🔍 불량 상세 분석 및 추적</h2>
            
            <!-- 현재 작업 컨텍스트 -->
            <div class="work-context-section">
                <h3 style="color: #0c4a6e; margin-bottom: 10px;">📋 현재 작업 정보 (자동 수집)</h3>
                <div class="work-context-grid">
                    <div class="context-item">
                        <span class="context-label">작업지시서:</span>
                        <span class="context-value" id="contextWorkNo">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">제품명:</span>
                        <span class="context-value" id="contextProduct">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">LOT 번호:</span>
                        <span class="context-value" id="contextLot">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">금형 번호:</span>
                        <span class="context-value" id="contextMold">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">작업자:</span>
                        <span class="context-value" id="contextWorkers">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">작업 경과:</span>
                        <span class="context-value" id="contextElapsed">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">현재 진행률:</span>
                        <span class="context-value" id="contextProgress">-</span>
                    </div>
                    <div class="context-item">
                        <span class="context-label">발생 시점:</span>
                        <span class="context-value" id="contextTime">-</span>
                    </div>
                </div>
            </div>
            
            <!-- 불량 분석 단계 -->
            <div class="defect-analysis-steps">
                <!-- 1단계: 기본 정보 -->
                <div class="analysis-step active" id="step1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">기본 불량 정보</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label>불량 수량 (m):</label>
                            <input type="number" id="analysisDefectQty" placeholder="0" step="0.1" style="width: 100%;">
                        </div>
                        <div>
                            <label>발견 위치:</label>
                            <select id="defectLocation" style="width: 100%;">
                                <option value="">선택하세요</option>
                                <option value="cutting">절단부</option>
                                <option value="bending">벤딩부</option>
                                <option value="surface">표면</option>
                                <option value="end">단부</option>
                                <option value="overall">전체</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 2단계: 불량 유형 -->
                <div class="analysis-step" id="step2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">불량 유형 분류</div>
                    </div>
                    <div class="defect-type-grid" id="defectTypeGrid">
                        <div class="defect-type-btn" onclick="selectDefectType('surface')">
                            <strong>표면불량</strong><br>
                            <small>긁힘, 찍힘, 오염 등</small>
                        </div>
                        <div class="defect-type-btn" onclick="selectDefectType('dimension')">
                            <strong>치수불량</strong><br>
                            <small>길이, 폭, 두께 이상</small>
                        </div>
                        <div class="defect-type-btn" onclick="selectDefectType('deformation')">
                            <strong>변형불량</strong><br>
                            <small>굽힘, 비틀림, 주름 등</small>
                        </div>
                        <div class="defect-type-btn" onclick="selectDefectType('foreign')">
                            <strong>이물질</strong><br>
                            <small>철분, 오일, 먼지 등</small>
                        </div>
                        <div class="defect-type-btn" onclick="selectDefectType('crack')">
                            <strong>크랙/파손</strong><br>
                            <small>균열, 파단, 찢어짐 등</small>
                        </div>
                        <div class="defect-type-btn" onclick="selectDefectType('other')">
                            <strong>기타</strong><br>
                            <small>분류되지 않는 불량</small>
                        </div>
                    </div>
                </div>
                
                <!-- 3단계: 원인 분석 -->
                <div class="analysis-step" id="step3">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">원인 분석 (근본원인 추적)</div>
                    </div>
                    <div class="cause-analysis-tree" id="causeTree">
                        <!-- 원인 분석 트리가 동적으로 생성됨 -->
                    </div>
                </div>
                
                <!-- 4단계: 개선 액션 -->
                <div class="analysis-step" id="step4">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">즉시 조치 및 개선 액션</div>
                    </div>
                    <div class="action-plan-section">
                        <div class="action-grid">
                            <div>
                                <label><strong>즉시 조치사항:</strong></label>
                                <textarea id="immediateAction" placeholder="지금 당장 해야 할 조치를 입력하세요..." style="width: 100%; height: 60px;"></textarea>
                            </div>
                            <div>
                                <label><strong>재발 방지 계획:</strong></label>
                                <textarea id="preventionPlan" placeholder="동일한 불량의 재발을 막기 위한 계획을 입력하세요..." style="width: 100%; height: 60px;"></textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label>조치 담당자:</label>
                                    <input type="text" id="actionOwner" placeholder="담당자명" style="width: 100%;">
                                </div>
                                <div>
                                    <label>완료 예정일:</label>
                                    <input type="date" id="actionDeadline" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 과거 유사 불량 이력 -->
            <div class="defect-history-section" id="defectHistorySection" style="display: none;">
                <h4 style="color: #92400e; margin-bottom: 10px;">⚠️ 과거 유사 불량 발생 이력</h4>
                <div id="similarDefectHistory">
                    <!-- 유사 불량 이력이 동적으로 표시됨 -->
                </div>
            </div>
            
            <!-- 불량 영향도 평가 -->
            <div class="defect-impact-alert" id="defectImpactAlert" style="display: none;">
                <div class="impact-level" id="impactLevel">높음</div>
                <div id="impactMessage">이 불량은 고객 클레임 위험이 높습니다. 즉시 관리자에게 보고하세요.</div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" onclick="closeDefectAnalysisModal()" style="background: #6b7280;">취소</button>
                <button class="btn" onclick="saveDetailedDefect()" style="background: #ef4444; color: white;">🚨 불량 등록 및 알림</button>
            </div>
        </div>
    </div>
    <div id="emergencyModal" class="modal hidden">
        <div class="modal-content">
            <h2>🚨 긴급상황 신고</h2>
            <p style="color: #ef4444; font-size: 14px; margin: 10px 0; font-weight: bold;">
                긴급상황을 선택하면 즉시 관리자에게 알림이 전송됩니다.
            </p>
            
            <div class="emergency-grid">
                <div class="emergency-item" onclick="reportEmergency('fire')">
                    <span class="icon">🔥</span>
                    화재/연기 발생
                </div>
                <div class="emergency-item" onclick="reportEmergency('accident')">
                    <span class="icon">⚠️</span>
                    안전사고 (부상)
                </div>
                <div class="emergency-item" onclick="reportEmergency('gas_leak')">
                    <span class="icon">💨</span>
                    가스/화학물질 누출
                </div>
                <div class="emergency-item" onclick="reportEmergency('power_failure')">
                    <span class="icon">⚡</span>
                    정전/시스템 장애
                </div>
                <div class="emergency-item" onclick="reportEmergency('earthquake')">
                    <span class="icon">🏃</span>
                    지진/자연재해
                </div>
                <div class="emergency-item" onclick="reportEmergency('other')">
                    <span class="icon">📞</span>
                    기타 응급상황
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="closeEmergencyModal()" style="background: #6b7280;">취소</button>
            </div>
        </div>
    </div>

    <script>
        // ===== 상수 정의 =====
        const CONFIG = {
            // 시간 관련
            WORK_CORRECTION_TIME_LIMIT_HOURS: 1,
            TIMER_UPDATE_INTERVAL: 1000,
            PRIORITY_UPDATE_INTERVAL: 30000,
            TOAST_DISPLAY_TIME: 3000,
            TOAST_ANIMATION_TIME: 300,
            
            // 검사 관련
            INSPECTION_PRODUCTS_COUNT: 3,
            INSPECTION_MAX_RETRY_COUNT: 3,
            CHECKLIST_ITEMS_COUNT: 8,
            SAFETY_CHECK_ITEMS_COUNT: 4,
            
            // 불량 관련
            DEFECT_CONSECUTIVE_TIME_MINUTES: 30,
            DEFECT_CONSECUTIVE_COUNT_THRESHOLD: 3,
            
            // 안전 관련
            SAFETY_LEVEL_1_DAYS: 30,
            SAFETY_LEVEL_2_DAYS: 100,
            SAFETY_LEVEL_3_DAYS: 200
        };

        // 정지 사유 텍스트 매핑
        const STOP_REASONS = {
            'coil_change': '코일준비교체',
            'bending_pack': '밴딩포장',
            'equipment_failure': '설비고장',
            'mold_change': '금형교체',
            'material_shortage': '자재부족',
            'maintenance': '정기점검',
            'break': '휴식시간',
            'meeting': '회의/교육',
            'other': '기타'
        };

        // 중단 사유 텍스트 매핑
        const PAUSE_REASONS = {
            'worker_change': '작업자 교대',
            'urgent_order': '긴급 작업',
            'meal_time': '식사 시간',
            'material_shortage': '자재 부족',
            'quality_issue': '품질 문제',
            'other': '기타'
        };

        // 불량 유형 텍스트 매핑
        const DEFECT_TYPES = {
            'surface': '표면불량',
            'dimension': '치수불량',
            'deformation': '변형',
            'foreign': '이물질',
            'crack': '크랙/파손',
            'other': '기타'
        };

        // 긴급상황 유형 매핑
        const EMERGENCY_TYPES = {
            'fire': '🔥 화재/연기 발생',
            'accident': '⚠️ 안전사고 (부상)',
            'gas_leak': '💨 가스/화학물질 누출',
            'power_failure': '⚡ 정전/시스템 장애',
            'earthquake': '🏃 지진/자연재해',
            'other': '📞 기타 응급상황'
        };

        // ===== 유틸리티 함수 =====
        const Utils = {
            // 시간 관련
            formatTime(date) {
                return date.toLocaleTimeString('ko-KR');
            },
            
            formatDate(date) {
                return date.toLocaleDateString('ko-KR');
            },
            
            formatDateTime(date) {
                return date.toLocaleString('ko-KR');
            },
            
            formatDuration(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            },
            
            getTimeDifference(startDate, endDate) {
                return endDate - startDate;
            },
            
            getElapsedMinutes(startDate) {
                return Math.floor((new Date() - startDate) / 60000);
            },
            
            // DOM 관련
            showModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            },
            
            hideModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            },
            
            showElement(elementId) {
                document.getElementById(elementId).style.display = 'block';
            },
            
            hideElement(elementId) {
                document.getElementById(elementId).style.display = 'none';
            },
            
            setElementText(elementId, text) {
                document.getElementById(elementId).textContent = text;
            },
            
            setElementHtml(elementId, html) {
                document.getElementById(elementId).innerHTML = html;
            },
            
            setElementValue(elementId, value) {
                document.getElementById(elementId).value = value;
            },
            
            getElementValue(elementId) {
                return document.getElementById(elementId).value;
            },
            
            setButtonState(buttonId, enabled) {
                document.getElementById(buttonId).disabled = !enabled;
            },
            
            // 작업자 관련 통합 함수
            getWorkersInfo() {
                const allWorkers = [currentWorker];
                if (isTwoPersonWork && subWorkers.length > 0) {
                    return {
                        all: allWorkers.concat(subWorkers),
                        display: `${currentWorker}(주), ${subWorkers.join(', ')}(보조)`,
                        simple: allWorkers.concat(subWorkers).join(', '),
                        count: allWorkers.concat(subWorkers).length
                    };
                }
                return {
                    all: allWorkers,
                    display: currentWorker,
                    simple: currentWorker,
                    count: 1
                };
            },
            
            // 데이터 변환
            parseNumber(value, defaultValue = 0) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            },
            
            // 검증
            isValidNumber(value) {
                return !isNaN(parseFloat(value)) && isFinite(value);
            },
            
            isEmpty(value) {
                return value === null || value === undefined || value === '';
            },
            
            // 알림 통합
            showAlert(message, type = 'info') {
                alert(message);
            },
            
            confirm(message) {
                return confirm(message);
            }
        };

        // ===== 전역 변수 =====
        var currentWorker = '';
        var currentMachine = '';
        var subWorkers = [];
        var isTwoPersonWork = false;
        var selectedWork = null;
        var workStartTime = null;
        var workStatus = 'idle';
        var stopStartTime = null;
        var totalStopTime = 0;
        var defectRecords = [];
        var totalProduction = 0;
        var timerInterval = null;
        var stopLog = [];
        var independentStopStartTime = null;
        var isIndependentStop = false;
        var correctionWork = null;
        var workHistory = [];
        var currentLotNumber = '';
        var previousLotNumber = '';
        var currentMoldNumber = '';
        var previousMoldNumber = '';
        var startChecklist = {};
        var firstProductInspection = {};
        var isLotChanged = false;
        var inspectionRetryCount = 0;
        var hasFailedInspection = false;
        var dailySafetyChecked = false;
        
        // 안전 현황 데이터
        var safetyData = {
            '1': { days: 89, lastAccident: '2024-10-28' },
            '2': { days: 156, lastAccident: '2024-07-22' },
            '3': { days: 127, lastAccident: '2024-08-20' },
            currentLine: '3',
            averageDays: 98,
            recordDays: 245
        };
        
        // 작업자 목록
        var workerList = ['김철수', '이영희', '박민수', '김수정', '이철수', '박영희', '최민호', '정대현', '강미영', '홍길동'];
        
        // 제품별 검사 기준
        var productCriteria = {
            'M-BAR-KS': {
                length: { min: 2990, max: 3010, unit: 'mm' },
                width: { min: 98, max: 102, unit: 'mm' },
                bend: { max: 2, unit: 'mm' }
            },
            'RUNNER 30': {
                length: { min: 1992, max: 2008, unit: 'mm' },
                width: { min: 29, max: 31, unit: 'mm' },
                bend: { max: 1, unit: 'mm' }
            },
            'STUD': {
                length: { min: 1495, max: 1505, unit: 'mm' },
                width: { min: 78, max: 82, unit: 'mm' },
                bend: { max: 1.5, unit: 'mm' }
            }
        };
        
        // 샘플 작업 데이터
        var workOrders = {
            '1': [
                { 
                    id: 1, 
                    name: '1-0122-01', 
                    product: 'M-BAR-KS', 
                    customer: 'A사', 
                    targetQty: 300, 
                    status: 'waiting', 
                    spec: '3000mm', 
                    pieces: 100, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 2,
                        deliveryTime: new Date(new Date().getTime() + 2 * 24 * 60 * 60 * 1000),
                        managerOrder: 2,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                },
                { 
                    id: 2, 
                    name: '1-0122-02', 
                    product: 'M-BAR-KS', 
                    customer: 'A사', 
                    targetQty: 375, 
                    status: 'waiting', 
                    spec: '2500mm', 
                    pieces: 150, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 1,
                        deliveryTime: new Date(new Date().getTime() + 5 * 60 * 60 * 1000),
                        managerOrder: 1,
                        autoOrder: 0,
                        reason: '출하시간 변경'
                    },
                    notifications: [
                        {
                            type: 'priority_change',
                            message: '긴급작업으로 변경됨',
                            timestamp: new Date(new Date().getTime() - 30 * 60 * 1000).toLocaleTimeString('ko-KR')
                        }
                    ]
                },
                { 
                    id: 3, 
                    name: '1-0122-03', 
                    product: 'M-BAR-KS', 
                    customer: '재고생산', 
                    targetQty: 600, 
                    status: 'waiting', 
                    spec: '3000mm', 
                    pieces: 200, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 3,
                        deliveryTime: new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000),
                        managerOrder: 3,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                }
            ],
            '2': [
                { 
                    id: 1, 
                    name: '2-0122-01', 
                    product: 'RUNNER 30', 
                    customer: 'B사', 
                    targetQty: 400, 
                    status: 'completed', 
                    spec: '2000mm', 
                    pieces: 200, 
                    actualQty: 400, 
                    history: [],
                    priority: {
                        urgency: 3,
                        deliveryTime: new Date(new Date().getTime() - 2 * 60 * 60 * 1000),
                        managerOrder: 1,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                },
                { 
                    id: 2, 
                    name: '2-0122-02', 
                    product: 'RUNNER 30', 
                    customer: 'C사', 
                    targetQty: 150, 
                    status: 'waiting', 
                    spec: '1500mm', 
                    pieces: 100, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 1,
                        deliveryTime: new Date(new Date().getTime() + 3 * 60 * 60 * 1000),
                        managerOrder: 1,
                        autoOrder: 0,
                        reason: '고객 요청'
                    },
                    notifications: [
                        {
                            type: 'urgent_added',
                            message: '고객 요청으로 긴급 처리',
                            timestamp: new Date(new Date().getTime() - 15 * 60 * 1000).toLocaleTimeString('ko-KR')
                        }
                    ]
                },
                { 
                    id: 3, 
                    name: '2-0122-03', 
                    product: 'RUNNER 30', 
                    customer: 'B사', 
                    targetQty: 300, 
                    status: 'waiting', 
                    spec: '2500mm', 
                    pieces: 120, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 2,
                        deliveryTime: new Date(new Date().getTime() + 1 * 24 * 60 * 60 * 1000),
                        managerOrder: 2,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                }
            ],
            '3': [
                { 
                    id: 1, 
                    name: '3-0122-01', 
                    product: 'M-BAR-KS', 
                    customer: 'A사', 
                    targetQty: 300, 
                    status: 'waiting', 
                    spec: '3000mm', 
                    pieces: 100, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 2,
                        deliveryTime: new Date(new Date().getTime() + 1 * 24 * 60 * 60 * 1000),
                        managerOrder: 2,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                },
                { 
                    id: 2, 
                    name: '3-0122-02', 
                    product: 'RUNNER 30', 
                    customer: 'D사', 
                    targetQty: 300, 
                    status: 'waiting', 
                    spec: '2000mm', 
                    pieces: 150, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 1,
                        deliveryTime: new Date(new Date().getTime() + 4 * 60 * 60 * 1000),
                        managerOrder: 1,
                        autoOrder: 0,
                        reason: '납기 단축'
                    },
                    notifications: [
                        {
                            type: 'delivery_changed',
                            message: '납기가 당겨졌습니다',
                            timestamp: new Date(new Date().getTime() - 45 * 60 * 1000).toLocaleTimeString('ko-KR')
                        }
                    ]
                },
                { 
                    id: 3, 
                    name: '3-0122-03', 
                    product: 'STUD', 
                    customer: 'B사', 
                    targetQty: 150, 
                    status: 'waiting', 
                    spec: '1500mm', 
                    pieces: 100, 
                    actualQty: 0, 
                    history: [],
                    priority: {
                        urgency: 3,
                        deliveryTime: new Date(new Date().getTime() + 3 * 24 * 60 * 60 * 1000),
                        managerOrder: 3,
                        autoOrder: 0,
                        reason: ''
                    },
                    notifications: []
                }
            ]
        };
        
        // 개선된 불량 관리 변수
        var detailedDefectRecords = [];
        var selectedDefectType = '';
        var selectedCause = '';
        var defectAnalysisStep = 1;
        
        // 불량 원인 분석 데이터
        var defectCauses = {
            'surface': {
                '설비 관련': [
                    '롤러 표면 손상',
                    '가이드 정렬 불량',
                    '윤활유 부족',
                    '청소 불량',
                    '온도 설정 이상'
                ],
                '자재 관련': [
                    '코일 표면 품질 불량',
                    '코일 두께 편차',
                    '코일 성분 이상',
                    '보관 중 오염',
                    '운반 중 손상'
                ],
                '작업 관련': [
                    '작업자 부주의',
                    '작업 속도 과도',
                    '취급 방법 부적절',
                    '점검 소홀',
                    '교육 부족'
                ],
                '환경 관련': [
                    '작업장 청결도 부족',
                    '온도/습도 이상',
                    '진동/충격',
                    '먼지/이물질',
                    '조명 불량'
                ]
            },
            'dimension': {
                '설비 관련': [
                    '금형 마모',
                    '압력 설정 이상',
                    '온도 제어 불량',
                    '기계 정밀도 저하',
                    '센서 오차'
                ],
                '자재 관련': [
                    '코일 두께 편차',
                    '코일 폭 불량',
                    '재질 경도 이상',
                    '성분 편차',
                    '열처리 불량'
                ],
                '작업 관련': [
                    '설정값 입력 오류',
                    '측정 방법 부적절',
                    '점검 주기 미준수',
                    '보정 작업 소홀',
                    '경험 부족'
                ]
            },
            'deformation': {
                '설비 관련': [
                    '금형 정렬 불량',
                    '압력 불균등',
                    '속도 제어 이상',
                    '진동 발생',
                    '마모 부품'
                ],
                '자재 관련': [
                    '코일 장력 이상',
                    '재질 연화',
                    '두께 불균등',
                    '표면 조도 불량',
                    '잔류 응력'
                ],
                '작업 관련': [
                    '작업 순서 오류',
                    '힘 조절 부적절',
                    '고정 방법 불량',
                    '취급 부주의',
                    '품질 확인 소홀'
                ]
            }
        };

        // ===== 기본 함수들 =====
        
        // 안전 색상 클래스 가져오기
        function getSafetyColorClass(days) {
            if (days < CONFIG.SAFETY_LEVEL_1_DAYS) return 'level-1';
            if (days < CONFIG.SAFETY_LEVEL_2_DAYS) return 'level-2';
            if (days < CONFIG.SAFETY_LEVEL_3_DAYS) return 'level-3';
            return 'level-4';
        }
        
        // 안전 현황 표시 업데이트
        function updateSafetyStatus() {
            var currentLineDays = safetyData[safetyData.currentLine].days;
            var colorClass = getSafetyColorClass(currentLineDays);
            
            var currentLineSafetyEl = document.getElementById('currentLineSafety');
            currentLineSafetyEl.textContent = safetyData.currentLine + '호기 ' + currentLineDays + '일 무사고';
            currentLineSafetyEl.className = 'safety-days ' + colorClass;
            
            Utils.setElementText('averageSafety', safetyData.averageDays);
            Utils.setElementText('recordSafety', safetyData.recordDays);
        }
        
        // 2인 작업 토글
        function toggleSubWorker() {
            var checkbox = document.getElementById('twoPersonWork');
            var section = document.getElementById('subWorkerSection');
            
            if (checkbox.checked) {
                Utils.showElement('subWorkerSection');
                generateSubWorkerList();
            } else {
                Utils.hideElement('subWorkerSection');
                subWorkers = [];
                updateSelectedSubWorkers();
            }
        }
        
        // 보조작업자 목록 생성
        function generateSubWorkerList() {
            var container = document.getElementById('subWorkerList');
            var mainWorker = Utils.getElementValue('workerName');
            
            container.innerHTML = '';
            
            workerList.forEach(function(worker) {
                if (worker !== mainWorker) {
                    var div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = worker;
                    checkbox.onchange = function() {
                        updateSubWorkers(worker, this.checked);
                    };
                    
                    var label = document.createElement('span');
                    label.textContent = worker;
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    container.appendChild(div);
                }
            });
        }
        
        // 보조작업자 업데이트
        function updateSubWorkers(worker, isSelected) {
            if (isSelected) {
                if (!subWorkers.includes(worker)) {
                    subWorkers.push(worker);
                }
            } else {
                subWorkers = subWorkers.filter(function(w) { return w !== worker; });
            }
            updateSelectedSubWorkers();
        }
        
        // 선택된 보조작업자 표시 업데이트
        function updateSelectedSubWorkers() {
            var display = document.getElementById('selectedSubWorkers');
            if (subWorkers.length === 0) {
                display.textContent = '선택된 보조작업자: 없음';
            } else {
                display.textContent = '선택된 보조작업자: ' + subWorkers.join(', ');
            }
        }
        
        // 주작업자 변경 시 보조작업자 목록 갱신
        document.addEventListener('DOMContentLoaded', function() {
            var mainWorkerSelect = document.getElementById('workerName');
            mainWorkerSelect.addEventListener('change', function() {
                if (document.getElementById('twoPersonWork').checked) {
                    generateSubWorkerList();
                }
            });
        });
        
        // 로그인 함수
        function doLogin() {
            currentWorker = Utils.getElementValue('workerName');
            currentMachine = Utils.getElementValue('machineNo');
            isTwoPersonWork = document.getElementById('twoPersonWork').checked;
            
            if (!currentWorker || !currentMachine) {
                Utils.showAlert('작업자와 호기를 선택하세요.');
                return;
            }
            
            if (isTwoPersonWork && subWorkers.length === 0) {
                Utils.showAlert('보조작업자를 선택하세요.');
                return;
            }
            
            // 안전 데이터의 현재 라인 업데이트
            safetyData.currentLine = currentMachine;
            
            // 일일 안전점검부터 시작
            showDailySafetyModal();
        }
        
        // 일일 안전점검 모달 표시
        function showDailySafetyModal() {
            Utils.showModal('dailySafetyModal');
            
            // 체크박스 초기화
            for (var i = 1; i <= CONFIG.SAFETY_CHECK_ITEMS_COUNT; i++) {
                document.getElementById('safetyCheck' + i).checked = false;
            }
            
            // 버튼 상태 초기화
            Utils.setButtonState('dailySafetyConfirmBtn', false);
            
            // 체크박스 이벤트 리스너 추가
            for (var i = 1; i <= CONFIG.SAFETY_CHECK_ITEMS_COUNT; i++) {
                document.getElementById('safetyCheck' + i).addEventListener('change', updateDailySafetyButton);
            }
        }
        
        // 일일 안전점검 버튼 상태 업데이트
        function updateDailySafetyButton() {
            var allChecked = true;
            for (var i = 1; i <= CONFIG.SAFETY_CHECK_ITEMS_COUNT; i++) {
                if (!document.getElementById('safetyCheck' + i).checked) {
                    allChecked = false;
                    break;
                }
            }
            Utils.setButtonState('dailySafetyConfirmBtn', allChecked);
        }
        
        // 일일 안전점검 확인
        function confirmDailySafety() {
            dailySafetyChecked = true;
            
            Utils.hideModal('dailySafetyModal');
            
            // 메인 화면으로 이동
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            // 작업자 정보 표시
            updateWorkerDisplay();
            
            // 안전 현황 표시 업데이트
            updateSafetyStatus();
            
            // 타이머 시작
            timerInterval = setInterval(updateTime, CONFIG.TIMER_UPDATE_INTERVAL);
            updateTime();
            
            loadWorkList();
            updateKPI();
            
            // 우선순위 변경 시뮬레이션
            setInterval(simulatePriorityChange, CONFIG.PRIORITY_UPDATE_INTERVAL);
            
            Utils.showAlert('안전점검이 완료되었습니다.\n안전한 하루 되세요! 👷‍♂️');
        }
        
        // 긴급상황 모달 표시
        function showEmergencyModal() {
            Utils.showModal('emergencyModal');
        }
        
        // 긴급상황 모달 닫기
        function closeEmergencyModal() {
            Utils.hideModal('emergencyModal');
        }
        
        // 긴급상황 신고
        function reportEmergency(type) {
            var emergencyReport = {
                type: type,
                typeText: EMERGENCY_TYPES[type],
                time: new Date(),
                reporter: currentWorker,
                machine: currentMachine,
                location: currentMachine + '호기',
                participants: Utils.getWorkersInfo().all
            };
            
            // 실제로는 관리자 시스템에 즉시 알림 전송
            console.log('긴급상황 신고:', emergencyReport);
            
            Utils.hideModal('emergencyModal');
            
            // 긴급상황별 대응 가이드
            var responseGuide = getEmergencyGuide(type);
            
            Utils.showAlert('🚨 긴급상황이 신고되었습니다!\n\n' +
                  '신고 내용: ' + EMERGENCY_TYPES[type] + '\n' +
                  '신고 시간: ' + Utils.formatTime(new Date()) + '\n' +
                  '신고 위치: ' + currentMachine + '호기\n\n' +
                  '📞 관리자에게 즉시 알림이 전송되었습니다.\n\n' +
                  '🔔 대응 가이드:\n' + responseGuide);
        }
        
        // 긴급상황별 대응 가이드
        function getEmergencyGuide(type) {
            var guides = {
                'fire': '1. 즉시 작업 중단\n2. 주변 인원 대피\n3. 119 신고\n4. 소화기 사용 (안전한 경우)',
                'accident': '1. 즉시 작업 중단\n2. 부상자 응급처치\n3. 119 신고\n4. 현장 보존',
                'gas_leak': '1. 즉시 작업 중단\n2. 환기 실시\n3. 누출 지점에서 대피\n4. 화기 사용 금지',
                'power_failure': '1. 설비 수동 정지\n2. 안전 위치로 이동\n3. 비상조명 확인\n4. 복구 대기',
                'earthquake': '1. 즉시 작업 중단\n2. 단단한 구조물 아래 대피\n3. 진동 멈춘 후 대피\n4. 엘리베이터 사용 금지',
                'other': '1. 즉시 작업 중단\n2. 안전 확보\n3. 관리자 지시 대기\n4. 현장 보존'
            };
            return guides[type] || '관리자 지시를 따르세요.';
        }
        
        // 작업자 정보 표시 업데이트
        function updateWorkerDisplay() {
            var mainInfo = currentMachine + '호기 | ' + currentWorker + ' (주작업자)';
            Utils.setElementText('workerInfo', mainInfo);
            
            var subInfo = document.getElementById('subWorkerInfo');
            if (isTwoPersonWork && subWorkers.length > 0) {
                subInfo.textContent = '보조작업자: ' + subWorkers.join(', ');
                Utils.showElement('subWorkerInfo');
            } else {
                Utils.hideElement('subWorkerInfo');
            }
        }
        
        // 시간 업데이트
        function updateTime() {
            var now = new Date();
            Utils.setElementText('currentTime', Utils.formatTime(now));
            
            // 작업 시간 계산
            if (workStartTime && workStatus === 'working') {
                var elapsed = Math.floor((now - workStartTime - totalStopTime) / 1000);
                var minutes = Math.floor(elapsed / 60);
                var seconds = elapsed % 60;
                Utils.setElementText('workTime', 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0'));
            }
            
            // 작업 중 설비 정지 시간 표시
            if (workStatus === 'stopped' && stopStartTime) {
                var stopElapsed = Math.floor((now - stopStartTime) / 1000);
                var stopMinutes = Math.floor(stopElapsed / 60);
                var stopSeconds = stopElapsed % 60;
                var currentWorkEl = document.getElementById('currentWork');
                currentWorkEl.innerHTML = 
                    currentWorkEl.innerHTML.split('<br>')[0] + 
                    '<br><span style="color: #ef4444;">정지 시간: ' + 
                    String(stopMinutes).padStart(2, '0') + ':' + 
                    String(stopSeconds).padStart(2, '0') + '</span>';
            }
            
            // 독립 설비 정지 시간 표시
            if (isIndependentStop && independentStopStartTime) {
                var indStopElapsed = Math.floor((now - independentStopStartTime) / 1000);
                var indStopMinutes = Math.floor(indStopElapsed / 60);
                var indStopSeconds = indStopElapsed % 60;
                Utils.setElementText('independentStopTime', 
                    '정지 시간: ' + String(indStopMinutes).padStart(2, '0') + ':' + 
                    String(indStopSeconds).padStart(2, '0'));
            } else {
                Utils.setElementText('independentStopTime', '');
            }
        }
        
        // 우선순위 계산
        function calculatePriority(work) {
            var now = new Date();
            var urgencyScore = 0;
            var deliveryScore = 0;
            var managerScore = 0;
            
            // 긴급도 점수 (40%)
            switch(work.priority.urgency) {
                case 1: urgencyScore = 100; break;
                case 2: urgencyScore = 70; break;
                case 3: urgencyScore = 40; break;
                default: urgencyScore = 20; break;
            }
            
            // 납기시간 점수 (30%)
            var timeDiff = work.priority.deliveryTime - now;
            var hoursLeft = timeDiff / (1000 * 60 * 60);
            
            if (hoursLeft < 0) deliveryScore = 0;
            else if (hoursLeft <= 4) deliveryScore = 100;
            else if (hoursLeft <= 8) deliveryScore = 90;
            else if (hoursLeft <= 24) deliveryScore = 70;
            else if (hoursLeft <= 72) deliveryScore = 50;
            else deliveryScore = 30;
            
            // 관리자 지정 점수 (30%)
            managerScore = Math.max(0, 100 - (work.priority.managerOrder - 1) * 20);
            
            // 가중평균 계산
            var totalScore = (urgencyScore * 0.4) + (deliveryScore * 0.3) + (managerScore * 0.3);
            
            return Math.round(totalScore);
        }
        
        // 작업 목록 자동 정렬
        function sortWorksByPriority(works) {
            return works
                .filter(work => work.status !== 'completed')
                .map(work => {
                    work.priority.autoOrder = calculatePriority(work);
                    return work;
                })
                .sort((a, b) => b.priority.autoOrder - a.priority.autoOrder);
        }
        
        // 우선순위 클래스 반환
        function getPriorityClass(urgency) {
            switch(urgency) {
                case 1: return 'urgent';
                case 2: return 'priority';
                case 3: return 'normal';
                default: return 'low';
            }
        }
        
        // 우선순위 아이콘 반환
        function getPriorityIcon(urgency) {
            switch(urgency) {
                case 1: return '🔥';
                case 2: return '⚡';
                case 3: return '📋';
                default: return '📝';
            }
        }
        
        // 납기까지 남은 시간 계산
        function getDeliveryTimeLeft(deliveryTime) {
            var now = new Date();
            var timeDiff = deliveryTime - now;
            var hoursLeft = Math.floor(timeDiff / (1000 * 60 * 60));
            var minutesLeft = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hoursLeft < 0) return '납기 지남';
            if (hoursLeft === 0) return minutesLeft + '분 남음';
            if (hoursLeft < 24) return hoursLeft + '시간 ' + minutesLeft + '분 남음';
            
            var daysLeft = Math.floor(hoursLeft / 24);
            return daysLeft + '일 남음';
        }
        
        // 작업 가이드 업데이트
        function updateWorkGuide() {
            var works = workOrders[currentMachine] || [];
            var sortedWorks = sortWorksByPriority(works);
            
            var recommendedWorkEl = document.getElementById('recommendedWork');
            var deliveryCountdownEl = document.getElementById('deliveryCountdown');
            
            if (sortedWorks.length === 0) {
                recommendedWorkEl.textContent = '작업이 없습니다';
                deliveryCountdownEl.textContent = '-';
                deliveryCountdownEl.className = 'delivery-countdown';
                return;
            }
            
            var nextWork = sortedWorks[0];
            var timeLeft = getDeliveryTimeLeft(nextWork.priority.deliveryTime);
            
            recommendedWorkEl.textContent = nextWork.name + ' (' + nextWork.product + ')';
            deliveryCountdownEl.textContent = '⏰ ' + timeLeft;
            
            // 긴급도에 따른 스타일 변경
            if (nextWork.priority.urgency === 1) {
                deliveryCountdownEl.className = 'delivery-countdown urgent';
            } else {
                deliveryCountdownEl.className = 'delivery-countdown';
            }
        }
        
        // 실시간 알림 토스트
        function showToast(type, title, message) {
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            var iconMap = {
                'success': '✅',
                'warning': '⚠️',
                'error': '❌',
                'info': '🔔'
            };
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-icon">${iconMap[type]}</span>
                    <span>${title}</span>
                </div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // 자동 제거
            setTimeout(function() {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, CONFIG.TOAST_ANIMATION_TIME);
            }, CONFIG.TOAST_DISPLAY_TIME);
        }
        
        // 우선순위 변경 시뮬레이션
        function simulatePriorityChange() {
            var works = workOrders[currentMachine] || [];
            if (works.length > 0) {
                var randomWork = works[Math.floor(Math.random() * works.length)];
                if (randomWork.status !== 'completed') {
                    var oldUrgency = randomWork.priority.urgency;
                    randomWork.priority.urgency = 1;
                    randomWork.priority.reason = '관리자 지시';
                    
                    randomWork.notifications.push({
                        type: 'priority_change',
                        message: '관리자가 긴급작업으로 변경',
                        timestamp: Utils.formatTime(new Date())
                    });
                    
                    showToast('warning', '우선순위 변경', 
                        randomWork.name + '이(가) 긴급작업으로 변경되었습니다.');
                    
                    loadWorkList();
                    updateWorkGuide();
                }
            }
        }
        
        // 작업 목록 로드
        function loadWorkList() {
            var workListDiv = document.getElementById('workList');
            var works = workOrders[currentMachine] || [];
            
            // 스마트 정렬 적용
            var sortedWorks = sortWorksByPriority(works);
            var completedWorks = works.filter(work => work.status === 'completed');
            
            workListDiv.innerHTML = '';
            
            // 대기/진행 중인 작업 표시
            sortedWorks.forEach(function(work, index) {
                var workElement = createWorkElement(work, index);
                workListDiv.appendChild(workElement);
            });
            
            // 완료된 작업 표시
            completedWorks.forEach(function(work) {
                var completedElement = createCompletedWorkElement(work);
                workListDiv.appendChild(completedElement);
            });
            
            // 작업 가이드 업데이트
            updateWorkGuide();
        }
        
        // 작업 요소 생성
        function createWorkElement(work, index) {
            var div = document.createElement('div');
            div.className = 'work-item ' + getPriorityClass(work.priority.urgency);
            
            // 2인 작업 이력이 있는 경우 스타일 추가
            var hasTwoPersonHistory = work.history && work.history.some(function(h) {
                return h.workers && h.workers.length > 1;
            });
            
            if (hasTwoPersonHistory) {
                div.classList.add('two-person-work');
            }
            
            // 상태별 스타일
            if (work.status === 'paused') {
                div.style.borderColor = '#f59e0b';
                div.style.backgroundColor = '#fef3c7';
            }
            
            var statusText = work.status === 'paused' ? '중단됨' : 
                           work.status === 'working' ? '진행중' : '대기';
            
            // 순서 배지
            var orderBadge = '';
            if (index === 0) orderBadge = '<div class="work-order-badge first">1순위 ⭐</div>';
            else if (index === 1) orderBadge = '<div class="work-order-badge second">2순위</div>';
            else if (index === 2) orderBadge = '<div class="work-order-badge third">3순위</div>';
            else orderBadge = '<div class="work-order-badge">' + (index + 1) + '순위</div>';
            
            // 알림 배지
            var notificationBadge = '';
            if (work.notifications.length > 0) {
                notificationBadge = '<div class="notification-badge">' + work.notifications.length + '</div>';
            }
            
            // 우선순위 아이콘
            var priorityIcon = getPriorityIcon(work.priority.urgency);
            var urgencyText = '';
            switch(work.priority.urgency) {
                case 1: urgencyText = '긴급'; break;
                case 2: urgencyText = '우선'; break;
                case 3: urgencyText = '일반'; break;
                default: urgencyText = '여유'; break;
            }
            
            // 납기 정보
            var deliveryInfo = getDeliveryTimeLeft(work.priority.deliveryTime);
            var deliveryClass = '';
            if (work.priority.urgency === 1) deliveryClass = 'urgent';
            else if (deliveryInfo.includes('시간')) deliveryClass = 'today';
            
            // 마지막 메모 확인
            var lastMemo = '';
            var lastWorkers = '';
            if (work.history && work.history.length > 0) {
                var lastHistory = work.history[work.history.length - 1];
                if (lastHistory.memo) {
                    lastMemo = lastHistory.memo;
                }
                if (lastHistory.workers && lastHistory.workers.length > 1) {
                    lastWorkers = ' (2인 작업: ' + lastHistory.workers.join(', ') + ')';
                }
            }
            
            // 최종 실적 계산
            var finalActualQty = work.actualQty + (work.correction ? work.correction.adjustedQty : 0);
            var correctionText = work.correction ? ' (수정됨 🔄)' : '';
            
            div.innerHTML = orderBadge + notificationBadge +
                           '<div class="work-priority-icons">' +
                           '<span class="priority-icon">' + priorityIcon + '</span>' +
                           '<span style="font-weight: bold; color: #374151;">[' + urgencyText + ']</span>' +
                           '<span style="background: #e5e7eb; color: #374151; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px;">점수: ' + work.priority.autoOrder + '</span>' +
                           '</div>' +
                           '<strong>' + work.name + '</strong> - ' + work.product + 
                           '<br>거래처: ' + work.customer + 
                           '<br>규격: ' + work.spec + ' × ' + work.pieces + 'EA' +
                           ' | 목표: ' + work.targetQty + 'm' +
                           (finalActualQty > 0 ? ' | 실적: ' + finalActualQty + 'm' + correctionText : '') +
                           '<br>상태: ' + statusText + lastWorkers +
                           '<div class="delivery-info ' + deliveryClass + '">📅 납기: ' + deliveryInfo + '</div>';
            
            // 사유가 있으면 표시
            if (work.priority.reason) {
                div.innerHTML += '<div style="font-size: 11px; color: #6b7280; margin-top: 3px;">🔄 ' + work.priority.reason + '</div>';
            }
            
            // 작업 이력이 있으면 표시
            if (work.history && work.history.length > 0) {
                div.innerHTML += '<br><span style="font-size: 12px; color: #666;">작업이력: ' + work.history.length + '건</span>';
            }
            
            // 메모가 있으면 표시
            if (lastMemo) {
                div.innerHTML += '<br><span style="font-size: 12px; color: #3b82f6;">📝 메모: ' + 
                               (lastMemo.length > 30 ? lastMemo.substring(0, 30) + '...' : lastMemo) + '</span>';
            }
            
            // 알림이 있으면 표시
            if (work.notifications.length > 0) {
                var notificationList = '<div class="notification-list">';
                work.notifications.slice(-2).forEach(function(notification) {
                    notificationList += '<div class="notification-item">🔔 ' + notification.message + ' (' + notification.timestamp + ')</div>';
                });
                notificationList += '</div>';
                div.innerHTML += notificationList;
            }
            
            // 수정 버튼 추가
            if (work.status === 'completed' && canCorrectWork(work)) {
                var correctionBtn = document.createElement('button');
                correctionBtn.className = 'btn';
                correctionBtn.style.cssText = 'font-size: 12px; padding: 5px 10px; margin-top: 10px; background: #f59e0b;';
                correctionBtn.textContent = '📝 실적 수정';
                correctionBtn.onclick = function(e) {
                    e.stopPropagation();
                    showCorrectionModal(work);
                };
                div.appendChild(correctionBtn);
            }
            
            div.onclick = function() {
                if (work.status !== 'completed') {
                    selectWork(work);
                }
            };
            
            return div;
        }
        
        // 완료된 작업 요소 생성
        function createCompletedWorkElement(work) {
            var div = document.createElement('div');
            div.className = 'work-item';
            div.style.opacity = '0.5';
            div.style.order = '999';
            
            var finalActualQty = work.actualQty + (work.correction ? work.correction.adjustedQty : 0);
            var correctionText = work.correction ? ' (수정됨 🔄)' : '';
            
            div.innerHTML = '<div class="work-order-badge" style="background: #10b981;">완료</div>' +
                           '<strong>' + work.name + '</strong> - ' + work.product + 
                           '<br>거래처: ' + work.customer + 
                           '<br>규격: ' + work.spec + ' × ' + work.pieces + 'EA' +
                           ' | 목표: ' + work.targetQty + 'm | 실적: ' + finalActualQty + 'm' + correctionText +
                           '<br>상태: 완료';
            
            // 수정 버튼 추가
            if (canCorrectWork(work)) {
                var correctionBtn = document.createElement('button');
                correctionBtn.className = 'btn';
                correctionBtn.style.cssText = 'font-size: 12px; padding: 5px 10px; margin-top: 10px; background: #f59e0b;';
                correctionBtn.textContent = '📝 실적 수정';
                correctionBtn.onclick = function(e) {
                    e.stopPropagation();
                    showCorrectionModal(work);
                };
                div.appendChild(correctionBtn);
            }
            
            return div;
        }
        
        // 작업 선택
        function selectWork(work) {
            selectedWork = work;
            
            // 기존 선택 해제
            document.querySelectorAll('.work-item').forEach(function(item) {
                item.classList.remove('selected');
                var existingCheckbox = item.querySelector('.selected-checkbox');
                var existingLabel = item.querySelector('.selected-label');
                if (existingCheckbox) existingCheckbox.remove();
                if (existingLabel) existingLabel.remove();
            });
            
            // 새로운 선택 표시
            var selectedItem = event.target.closest('.work-item');
            selectedItem.classList.add('selected');
            
            // 체크박스 추가
            var checkbox = document.createElement('div');
            checkbox.className = 'selected-checkbox';
            checkbox.innerHTML = '✓';
            selectedItem.appendChild(checkbox);
            
            // 선택 라벨 추가
            var label = document.createElement('div');
            label.className = 'selected-label';
            label.textContent = '✅ 선택된 작업';
            selectedItem.appendChild(label);
            
            // 버튼 활성화
            if (work.status === 'paused') {
                Utils.setButtonState('startBtn', false);
                Utils.setButtonState('resumeWorkBtn', true);
                Utils.setElementText('currentWork', '선택된 작업: ' + work.name + ' (중단됨 - 실적: ' + work.actualQty + 'm)');
                
                // 마지막 메모 표시
                var lastMemo = '';
                if (work.history && work.history.length > 0) {
                    for (var i = work.history.length - 1; i >= 0; i--) {
                        if (work.history[i].memo) {
                            lastMemo = work.history[i].memo;
                            break;
                        }
                    }
                }
                if (lastMemo) {
                    document.getElementById('currentWork').innerHTML += 
                        '<br><span style="font-size: 12px; color: #666;">이전 메모: ' + lastMemo + '</span>';
                }
            } else {
                Utils.setButtonState('startBtn', true);
                Utils.setButtonState('resumeWorkBtn', false);
                
                // 우선순위 정보와 함께 표시
                var priorityText = '';
                switch(work.priority.urgency) {
                    case 1: priorityText = ' 🔥 [긴급]'; break;
                    case 2: priorityText = ' ⚡ [우선]'; break;
                    case 3: priorityText = ' 📋 [일반]'; break;
                    default: priorityText = ' 📝 [여유]'; break;
                }
                
                var deliveryInfo = getDeliveryTimeLeft(work.priority.deliveryTime);
                Utils.setElementHtml('currentWork', 
                    '<span style="color: #3b82f6; font-weight: bold;">✅ 선택된 작업:</span> ' + 
                    work.name + priorityText + 
                    '<br><span style="font-size: 12px; color: #666;">📅 납기: ' + deliveryInfo + '</span>');
            }
            
            // 선택 효과음 시뮬레이션
            console.log('작업 선택됨:', work.name);
            
            // 햅틱 피드백 시뮬레이션
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // 작업 시작
        function startWork() {
            if (!selectedWork) {
                Utils.showAlert('작업을 선택하세요.');
                return;
            }
            
            // LOT 번호 입력 모달 표시
            showLotModal();
        }
        
        // 설비 정지 모달 표시
        function showStopModal() {
            Utils.showModal('stopModal');
            Utils.setElementValue('stopReason', '');
        }
        
        // 설비 정지 확인
        function confirmStop() {
            var reason = Utils.getElementValue('stopReason');
            if (!reason) {
                Utils.showAlert('정지 사유를 선택하세요.');
                return;
            }
            
            workStatus = 'stopped';
            stopStartTime = new Date();
            
            // 정지 로그 기록
            stopLog.push({
                reason: reason,
                reasonText: STOP_REASONS[reason] || reason,
                startTime: stopStartTime,
                workers: Utils.getWorkersInfo().all,
                workNo: selectedWork.name
            });
            
            Utils.setButtonState('stopBtn', false);
            Utils.setButtonState('resumeBtn', true);
            Utils.setButtonState('pauseBtn', false);
            
            // 불량 알림 섹션 숨김
            Utils.hideElement('defectAlertSection');
            
            Utils.hideModal('stopModal');
            Utils.showAlert('설비가 정지되었습니다.');
        }
        
        // 설비 정지 취소
        function cancelStop() {
            Utils.hideModal('stopModal');
        }
        
        // 작업 재개
        function resumeWork() {
            if (workStatus !== 'stopped') return;
            
            var stopEndTime = new Date();
            var stopDuration = stopEndTime - stopStartTime;
            totalStopTime += stopDuration;
            
            // 마지막 정지 로그 업데이트
            var lastStop = stopLog[stopLog.length - 1];
            lastStop.endTime = stopEndTime;
            lastStop.duration = stopDuration;
            
            workStatus = 'working';
            
            Utils.setButtonState('stopBtn', true);
            Utils.setButtonState('resumeBtn', false);
            Utils.setButtonState('pauseBtn', true);
            Utils.setButtonState('endBtn', true);
            
            // 정지 기록 화면 업데이트
            updateStopLogList();
            
            Utils.showAlert('작업을 재개합니다.');
        }
        
        // 작업 중단 모달 표시
        function showPauseWorkModal() {
            Utils.showModal('pauseWorkModal');
            Utils.setElementValue('pauseQty', '');
            Utils.setElementValue('pauseReason', '');
            Utils.setElementValue('pauseMemo', '');
            document.getElementById('pauseQty').focus();
        }
        
        // 작업 중단 확인
        function confirmPauseWork() {
            var qty = Utils.getElementValue('pauseQty');
            var reason = Utils.getElementValue('pauseReason');
            var memo = Utils.getElementValue('pauseMemo').trim();
            
            if (!qty || qty <= 0) {
                Utils.showAlert('현재까지 생산량을 입력하세요.');
                return;
            }
            
            if (!reason) {
                Utils.showAlert('중단 사유를 선택하세요.');
                return;
            }
            
            var pauseQty = parseFloat(qty);
            var workEndTime = new Date();
            
            // 작업 이력 추가
            if (!selectedWork.history) {
                selectedWork.history = [];
            }
            
            selectedWork.history.push({
                workers: Utils.getWorkersInfo().all,
                mainWorker: currentWorker,
                subWorkers: subWorkers.slice(),
                startTime: workStartTime,
                endTime: workEndTime,
                production: pauseQty,
                reason: PAUSE_REASONS[reason] || reason,
                type: 'pause',
                memo: memo,
                isTwoPersonWork: isTwoPersonWork,
                lotNumber: currentLotNumber,
                moldNumber: currentMoldNumber,
                startChecklist: startChecklist,
                firstProductInspection: firstProductInspection
            });
            
            // 누적 생산량 업데이트
            selectedWork.actualQty += pauseQty;
            totalProduction += pauseQty;
            
            // 상태 변경
            selectedWork.status = 'paused';
            workStatus = 'idle';
            
            // UI 초기화
            workStartTime = null;
            Utils.setButtonState('startBtn', false);
            Utils.setButtonState('stopBtn', false);
            Utils.setButtonState('resumeBtn', false);
            Utils.setButtonState('pauseBtn', false);
            Utils.setButtonState('endBtn', false);
            Utils.setButtonState('resumeWorkBtn', false);
            Utils.setElementText('currentWork', '');
            Utils.setElementText('previousProduction', '');
            Utils.setElementText('workTime', '00:00');
            
            Utils.hideModal('pauseWorkModal');
            
            loadWorkList();
            updateKPI();
            
            var alertMsg = '작업이 중단되었습니다. 생산량: ' + pauseQty + 'm (누적: ' + selectedWork.actualQty + 'm)';
            if (isTwoPersonWork) {
                alertMsg += '\n참여자: ' + Utils.getWorkersInfo().display;
            }
            if (memo) {
                alertMsg += '\n인수인계 메모가 저장되었습니다.';
            }
            Utils.showAlert(alertMsg);
            
            selectedWork = null;
        }
        
        // 작업 중단 취소
        function cancelPauseWork() {
            Utils.hideModal('pauseWorkModal');
        }
        
        // 중단된 작업 재개
        function resumePausedWork() {
            if (!selectedWork || selectedWork.status !== 'paused') {
                Utils.showAlert('중단된 작업을 선택하세요.');
                return;
            }
            
            // LOT 번호 입력 모달 표시
            showLotModal();
        }
        
        // 작업 종료 모달 표시
        function showEndWorkModal() {
            Utils.showModal('endWorkModal');
            Utils.setElementValue('goodQty', '');
            document.getElementById('goodQty').focus();
        }
        
        // 작업 종료 확인
        function confirmEndWork() {
            var goodQty = Utils.getElementValue('goodQty');
            
            if (!goodQty || goodQty <= 0) {
                Utils.showAlert('양품 수량을 입력하세요.');
                return;
            }
            
            goodQty = parseFloat(goodQty);
            var workEndTime = new Date();
            
            // 작업 이력 추가
            if (!selectedWork.history) {
                selectedWork.history = [];
            }
            
            selectedWork.history.push({
                workers: Utils.getWorkersInfo().all,
                mainWorker: currentWorker,
                subWorkers: subWorkers.slice(),
                startTime: workStartTime,
                endTime: workEndTime,
                production: goodQty,
                type: 'complete',
                isTwoPersonWork: isTwoPersonWork,
                lotNumber: currentLotNumber,
                moldNumber: currentMoldNumber,
                startChecklist: startChecklist,
                firstProductInspection: firstProductInspection
            });
            
            // 최종 생산량
            selectedWork.actualQty += goodQty;
            selectedWork.status = 'completed';
            totalProduction += goodQty;
            
            var finalActualQty = selectedWork.actualQty;
            
            workStartTime = null;
            workStatus = 'idle';
            selectedWork = null;
            totalStopTime = 0;
            
            Utils.setButtonState('startBtn', false);
            Utils.setButtonState('stopBtn', false);
            Utils.setButtonState('resumeBtn', false);
            Utils.setButtonState('pauseBtn', false);
            Utils.setButtonState('endBtn', false);
            Utils.setButtonState('resumeWorkBtn', false);
            Utils.setElementText('currentWork', '');
            Utils.setElementText('previousProduction', '');
            Utils.setElementText('workTime', '00:00');
            
            Utils.hideModal('endWorkModal');
            
            loadWorkList();
            updateKPI();
            
            var alertMsg = '작업이 완료되었습니다. 이번 생산량: ' + goodQty + 'm (총 생산량: ' + finalActualQty + 'm)';
            if (isTwoPersonWork) {
                alertMsg += '\n참여자: ' + Utils.getWorkersInfo().display;
            }
            Utils.showAlert(alertMsg);
        }
        
        // 작업 종료 취소
        function cancelEndWork() {
            Utils.hideModal('endWorkModal');
        }
        
        // 불량 저장
        function saveDefect() {
            var qty = Utils.getElementValue('defectQty');
            var type = Utils.getElementValue('defectType');
            
            if (!qty || !type) {
                Utils.showAlert('불량 수량과 유형을 입력하세요.');
                return;
            }
            
            var defect = {
                time: Utils.formatTime(new Date()),
                qty: parseFloat(qty),
                type: type,
                typeText: DEFECT_TYPES[type] || type,
                workers: Utils.getWorkersInfo().all,
                machine: currentMachine
            };
            
            defectRecords.push(defect);
            
            updateDefectList();
            updateKPI();
            
            Utils.showAlert('불량이 기록되었습니다.');
            Utils.setElementValue('defectQty', '');
            Utils.setElementValue('defectType', '');
        }
        
        // 불량 목록 업데이트
        function updateDefectList() {
            var listDiv = document.getElementById('defectList');
            var summaryEl = document.getElementById('defectSummary');
            
            if (defectRecords.length === 0) {
                listDiv.innerHTML = '아직 기록된 불량이 없습니다.';
                summaryEl.textContent = '';
                return;
            }
            
            // 요약 정보 계산
            var totalQty = defectRecords.reduce(function(sum, d) { return sum + d.qty; }, 0);
            var detailedCount = defectRecords.filter(function(d) { return d.isDetailed; }).length;
            var simpleCount = defectRecords.length - detailedCount;
            
            summaryEl.textContent = `(총 ${defectRecords.length}건, ${totalQty}m - 상세분석: ${detailedCount}건, 일반기록: ${simpleCount}건)`;
            
            listDiv.innerHTML = '';
            
            // 최신 순으로 정렬
            var sortedDefects = defectRecords.slice().reverse();
            
            sortedDefects.forEach(function(defect, index) {
                var div = document.createElement('div');
                div.className = 'defect-item';
                
                var workersInfo = defect.workers && defect.workers.length > 1 ? 
                    ' (' + defect.workers.join(', ') + ')' : ' (' + defect.workers[0] + ')';
                
                var defectTypeDisplay = defect.typeText || DEFECT_TYPES[defect.type] || defect.type;
                
                // 상세 분석된 불량인 경우
                if (defect.isDetailed) {
                    var detailedRecord = detailedDefectRecords.find(function(d) { return d.id === defect.detailId; });
                    
                    div.style.borderLeft = '4px solid #ef4444';
                    div.style.background = '#fef2f2';
                    
                    var contextInfo = '';
                    if (detailedRecord && detailedRecord.workContext) {
                        contextInfo = `<br><span style="font-size: 11px; color: #666;">
                            작업: ${detailedRecord.workContext.workNo || '-'} | 
                            LOT: ${detailedRecord.workContext.lotNumber || '-'} | 
                            진행률: ${detailedRecord.workContext.currentProgress || 0}m
                        </span>`;
                    }
                    
                    var causeInfo = detailedRecord ? 
                        `<br><span style="font-size: 11px; color: #ef4444;">원인: ${detailedRecord.cause}</span>` : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold;">상세분석</span>
                            <span style="font-weight: bold;">${defect.time} - ${defect.qty}m (${defectTypeDisplay})${workersInfo}</span>
                        </div>
                        ${contextInfo}
                        ${causeInfo}
                        <button onclick="showDefectDetail(${defect.detailId})" style="margin-top: 8px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            📋 상세보기
                        </button>
                    `;
                } else {
                    // 일반 불량 기록
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #6b7280; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">일반기록</span>
                            <span>${defect.time} - ${defect.qty}m (${defectTypeDisplay})${workersInfo}</span>
                        </div>
                    `;
                }
                
                listDiv.appendChild(div);
            });
        }
        
        // KPI 업데이트
        function updateKPI() {
            // 총 생산량 (수정량 포함)
            var adjustedTotalProduction = totalProduction;
            var works = workOrders[currentMachine] || [];
            works.forEach(function(work) {
                if (work.correction) {
                    adjustedTotalProduction += work.correction.adjustedQty;
                }
            });
            
            Utils.setElementText('totalProduction', adjustedTotalProduction + 'm');
            
            // 달성률 계산
            var totalTargetQty = 0;
            var totalActualQty = 0;
            
            works.forEach(function(work) {
                totalTargetQty += work.targetQty;
                var workActualQty = work.actualQty + (work.correction ? work.correction.adjustedQty : 0);
                totalActualQty += workActualQty;
            });
            
            var achievementRate = totalTargetQty > 0 ? 
                (totalActualQty / totalTargetQty * 100).toFixed(1) : 0;
            
            Utils.setElementText('achievementRate', achievementRate + '%');
            
            // 달성률에 따른 색상 변경
            var achievementElement = document.getElementById('achievementRate');
            if (achievementRate >= 100) {
                achievementElement.style.color = '#10b981';
            } else if (achievementRate >= 80) {
                achievementElement.style.color = '#1e3a8a';
            } else if (achievementRate >= 60) {
                achievementElement.style.color = '#f59e0b';
            } else {
                achievementElement.style.color = '#ef4444';
            }
            
            // 불량률 계산
            var totalDefects = defectRecords.reduce(function(sum, d) { return sum + d.qty; }, 0);
            var defectRate = adjustedTotalProduction > 0 ? 
                (totalDefects / (adjustedTotalProduction + totalDefects) * 100).toFixed(1) : 0;
            Utils.setElementText('defectRate', defectRate + '%');
            
            // 불량률에 따른 색상 변경
            var defectElement = document.getElementById('defectRate');
            if (defectRate >= 5) {
                defectElement.style.color = '#ef4444';
            } else if (defectRate >= 3) {
                defectElement.style.color = '#f59e0b';
            } else {
                defectElement.style.color = '#10b981';
            }
        }
        
        // 로그아웃
        function logout() {
            if (Utils.confirm('로그아웃 하시겠습니까?')) {
                clearInterval(timerInterval);
                
                // 전역 변수 초기화
                currentWorker = '';
                currentMachine = '';
                subWorkers = [];
                isTwoPersonWork = false;
                selectedWork = null;
                workStartTime = null;
                workStatus = 'idle';
                stopStartTime = null;
                totalStopTime = 0;
                defectRecords = [];
                totalProduction = 0;
                independentStopStartTime = null;
                isIndependentStop = false;
                stopLog = [];
                dailySafetyChecked = false;
                
                // 화면 전환
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainScreen').classList.add('hidden');
                
                // 입력 필드 초기화
                Utils.setElementValue('workerName', '');
                Utils.setElementValue('machineNo', '');
                document.getElementById('twoPersonWork').checked = false;
                Utils.hideElement('subWorkerSection');
            }
        }
        
        // 설비 정지 목록 업데이트
        function updateStopLogList() {
            var listDiv = document.getElementById('stopLogList');
            if (stopLog.length === 0) {
                listDiv.innerHTML = '아직 설비 정지 기록이 없습니다.';
                return;
            }
            
            listDiv.innerHTML = '';
            stopLog.forEach(function(stop) {
                if (stop.endTime) {
                    var durationMs = stop.endTime - stop.startTime;
                    var durationText = Utils.formatDuration(durationMs);
                    
                    var workersInfo = stop.workers && stop.workers.length > 1 ? 
                        ' (' + stop.workers.join(', ') + ')' : ' (' + stop.workers[0] + ')';
                    
                    var div = document.createElement('div');
                    div.className = 'defect-item';
                    div.innerHTML = Utils.formatTime(stop.startTime) + ' - ' + 
                                   stop.reasonText + ' (' + durationText + ') - ' + 
                                   stop.workNo + workersInfo;
                    listDiv.appendChild(div);
                }
            });
        }
        
        // 독립 설비 정지 모달 표시
        function showIndependentStopModal() {
            if (isIndependentStop) {
                Utils.showAlert('이미 설비가 정지 중입니다.');
                return;
            }
            Utils.showModal('independentStopModal');
            Utils.setElementValue('independentStopReason', '');
        }
        
        // 독립 설비 정지 확인
        function confirmIndependentStop() {
            var reason = Utils.getElementValue('independentStopReason');
            if (!reason) {
                Utils.showAlert('정지 사유를 선택하세요.');
                return;
            }
            
            isIndependentStop = true;
            independentStopStartTime = new Date();
            
            Utils.setButtonState('independentStopBtn', false);
            Utils.setButtonState('independentResumeBtn', true);
            Utils.setElementText('independentStopStatus', 
                '설비 정지 중: ' + (STOP_REASONS[reason] || reason));
            
            Utils.hideModal('independentStopModal');
            Utils.showAlert('설비 정지가 기록되었습니다: ' + (STOP_REASONS[reason] || reason));
        }
        
        // 독립 설비 정지 취소
        function cancelIndependentStop() {
            Utils.hideModal('independentStopModal');
        }
        
        // 독립 설비 재가동
        function independentResume() {
            if (!isIndependentStop) return;
            
            var stopEndTime = new Date();
            var stopDuration = stopEndTime - independentStopStartTime;
            
            // 정지 로그에 기록
            stopLog.push({
                reason: '독립정지',
                reasonText: document.getElementById('independentStopStatus').textContent.replace('설비 정지 중: ', ''),
                startTime: independentStopStartTime,
                endTime: stopEndTime,
                duration: stopDuration,
                workers: Utils.getWorkersInfo().all,
                workNo: '작업 외'
            });
            
            isIndependentStop = false;
            independentStopStartTime = null;
            
            Utils.setButtonState('independentStopBtn', true);
            Utils.setButtonState('independentResumeBtn', false);
            Utils.setElementText('independentStopStatus', '');
            Utils.setElementText('independentStopTime', '');
            
            updateStopLogList();
            
            Utils.showAlert('설비가 재가동되었습니다.');
        }
        
        // 작업 수정 가능 여부 확인
        function canCorrectWork(work) {
            if (!work.history || work.history.length === 0) return false;
            
            // 마지막 완료 기록 찾기
            var lastCompleteHistory = null;
            for (var i = work.history.length - 1; i >= 0; i--) {
                if (work.history[i].type === 'complete') {
                    lastCompleteHistory = work.history[i];
                    break;
                }
            }
            
            if (!lastCompleteHistory) return false;
            
            var now = new Date();
            var timeDiff = now - new Date(lastCompleteHistory.endTime);
            var hoursPassed = timeDiff / (1000 * 60 * 60);
            
            return hoursPassed <= CONFIG.WORK_CORRECTION_TIME_LIMIT_HOURS;
        }
        
        // 실적 수정 모달 표시
        function showCorrectionModal(work) {
            correctionWork = work;
            
            Utils.setElementText('correctionWorkName', work.name);
            Utils.setElementText('correctionCurrentQty', work.actualQty);
            Utils.setElementValue('correctionAdjustQty', '');
            Utils.setElementValue('correctionReason', '');
            Utils.hideElement('correctionPreview');
            
            // 수정량 입력 시 미리보기 업데이트
            document.getElementById('correctionAdjustQty').addEventListener('input', updateCorrectionPreview);
            
            Utils.showModal('correctionModal');
        }
        
        // 수정 미리보기 업데이트
        function updateCorrectionPreview() {
            var adjustQty = parseFloat(Utils.getElementValue('correctionAdjustQty')) || 0;
            var currentQty = correctionWork.actualQty;
            var newQty = currentQty + adjustQty;
            
            if (adjustQty !== 0) {
                var previewText = currentQty + 'm → ' + newQty + 'm (' + 
                    (adjustQty > 0 ? '+' : '') + adjustQty + 'm)';
                Utils.setElementText('correctionPreviewText', previewText);
                Utils.showElement('correctionPreview');
            } else {
                Utils.hideElement('correctionPreview');
            }
        }
        
        // 실적 수정 확인
        function confirmCorrection() {
            var adjustQty = parseFloat(Utils.getElementValue('correctionAdjustQty'));
            var reason = Utils.getElementValue('correctionReason');
            
            if (isNaN(adjustQty) || adjustQty === 0) {
                Utils.showAlert('수정량을 입력하세요. (0이 아닌 값)');
                return;
            }
            
            if (!reason) {
                Utils.showAlert('수정 사유를 선택하세요.');
                return;
            }
            
            var newTotal = correctionWork.actualQty + adjustQty;
            if (newTotal < 0) {
                Utils.showAlert('수정 후 실적이 음수가 될 수 없습니다.');
                return;
            }
            
            // 수정 정보 저장
            correctionWork.correction = {
                adjustedQty: adjustQty,
                reason: reason,
                correctedBy: currentWorker,
                correctedAt: new Date(),
                originalQty: correctionWork.actualQty
            };
            
            // 전체 생산량에 반영
            totalProduction += adjustQty;
            
            // UI 업데이트
            loadWorkList();
            updateKPI();
            
            Utils.hideModal('correctionModal');
            
            Utils.showAlert('실적이 수정되었습니다.\n' + 
                  correctionWork.actualQty + 'm → ' + newTotal + 'm (' + 
                  (adjustQty > 0 ? '+' : '') + adjustQty + 'm)');
            
            correctionWork = null;
        }
        
        // 실적 수정 취소
        function cancelCorrection() {
            Utils.hideModal('correctionModal');
            correctionWork = null;
        }
        
        // LOT 모달 표시
        function showLotModal() {
            Utils.showModal('lotModal');
            Utils.setElementValue('lotSelect', '');
            Utils.setElementValue('manualLot', '');
            Utils.hideElement('manualLotInput');
            Utils.setElementValue('moldSelect', '');
            Utils.setElementValue('manualMold', '');
            Utils.hideElement('manualMoldInput');
            document.getElementById('sameLotCheck').checked = false;
            
            // 이전 정보 표시
            if (previousLotNumber || previousMoldNumber) {
                if (previousLotNumber) {
                    Utils.setElementText('previousLotInfo', '이전 LOT: ' + previousLotNumber);
                }
                if (previousMoldNumber) {
                    Utils.setElementText('previousMoldInfo', '이전 금형: ' + previousMoldNumber);
                }
                Utils.showElement('previousInfo');
            } else {
                Utils.hideElement('previousInfo');
            }
        }
        
        // LOT 선택 처리
        function handleLotSelect() {
            var select = Utils.getElementValue('lotSelect');
            
            if (select === 'manual') {
                Utils.showElement('manualLotInput');
                document.getElementById('manualLot').focus();
            } else {
                Utils.hideElement('manualLotInput');
            }
        }
        
        // 금형 선택 처리
        function handleMoldSelect() {
            var select = Utils.getElementValue('moldSelect');
            
            if (select === 'manual') {
                Utils.showElement('manualMoldInput');
                document.getElementById('manualMold').focus();
            } else {
                Utils.hideElement('manualMoldInput');
            }
        }
        
        // 동일 설정 체크 처리
        function handleSameLot() {
            var checkbox = document.getElementById('sameLotCheck');
            var lotSelect = document.getElementById('lotSelect');
            var moldSelect = document.getElementById('moldSelect');
            
            if (checkbox.checked && (previousLotNumber || previousMoldNumber)) {
                lotSelect.disabled = true;
                moldSelect.disabled = true;
                Utils.hideElement('manualLotInput');
                Utils.hideElement('manualMoldInput');
            } else {
                lotSelect.disabled = false;
                moldSelect.disabled = false;
            }
        }
        
        // LOT 확인
        function confirmLot() {
            var lotNumber = '';
            var moldNumber = '';
            var checkbox = document.getElementById('sameLotCheck');
            
            if (checkbox.checked && (previousLotNumber || previousMoldNumber)) {
                lotNumber = previousLotNumber;
                moldNumber = previousMoldNumber;
            } else {
                // LOT 번호 가져오기
                var lotSelect = Utils.getElementValue('lotSelect');
                if (lotSelect === 'manual') {
                    lotNumber = Utils.getElementValue('manualLot').trim();
                } else {
                    lotNumber = lotSelect;
                }
                
                // 금형 번호 가져오기
                var moldSelect = Utils.getElementValue('moldSelect');
                if (moldSelect === 'manual') {
                    moldNumber = Utils.getElementValue('manualMold').trim();
                } else {
                    moldNumber = moldSelect;
                }
            }
            
            if (!lotNumber) {
                Utils.showAlert('LOT 번호를 입력하세요.');
                return;
            }
            
            if (!moldNumber) {
                Utils.showAlert('금형 번호를 입력하세요.');
                return;
            }
            
            // LOT 변경 여부 확인
            isLotChanged = (previousLotNumber && previousLotNumber !== lotNumber);
            
            currentLotNumber = lotNumber;
            currentMoldNumber = moldNumber;
            previousLotNumber = lotNumber;
            previousMoldNumber = moldNumber;
            
            Utils.hideModal('lotModal');
            
            // 시작 점검 모달 표시
            showChecklistModal();
        }
        
        // LOT 취소
        function cancelLot() {
            Utils.hideModal('lotModal');
        }
        
        // 시작 점검 모달 표시
        function showChecklistModal() {
            Utils.showModal('checklistModal');
            
            // 작업 정보 표시
            Utils.setElementText('checklistWorkNo', selectedWork.name);
            
            // 작업별 특화 안전사항 설정
            setWorkSpecificSafety();
            
            // 체크박스 초기화
            for (var i = 1; i <= CONFIG.CHECKLIST_ITEMS_COUNT; i++) {
                document.getElementById('check' + i).checked = false;
            }
            
            // 버튼 상태 초기화
            Utils.setButtonState('checklistConfirmBtn', false);
            
            // 체크박스 이벤트 리스너 추가
            for (var i = 1; i <= CONFIG.CHECKLIST_ITEMS_COUNT; i++) {
                document.getElementById('check' + i).addEventListener('change', updateChecklistButton);
            }
        }
        
        // 작업별 특화 안전사항 설정
        function setWorkSpecificSafety() {
            var safetyText = '';
            
            if (isTwoPersonWork) {
                safetyText = '2인 작업 - 협업 신호 및 역할 분담 확인';
            } else if (selectedWork.product === 'M-BAR-KS') {
                safetyText = 'M-BAR 작업 - 대형 제품 취급 시 주의';
            } else if (selectedWork.product === 'RUNNER 30') {
                safetyText = 'RUNNER 작업 - 절단면 날카로움 주의';
            } else if (selectedWork.product === 'STUD') {
                safetyText = 'STUD 작업 - 돌출부 찔림 주의';
            } else {
                safetyText = '해당 제품의 안전 주의사항 확인';
            }
            
            Utils.setElementText('workSpecificSafety', safetyText);
        }
        
        // 체크리스트 버튼 상태 업데이트
        function updateChecklistButton() {
            var allChecked = true;
            for (var i = 1; i <= CONFIG.CHECKLIST_ITEMS_COUNT; i++) {
                if (!document.getElementById('check' + i).checked) {
                    allChecked = false;
                    break;
                }
            }
            Utils.setButtonState('checklistConfirmBtn', allChecked);
        }
        
        // 체크리스트 확인
        function confirmChecklist() {
            // 점검 결과 저장
            startChecklist = {
                equipmentCheck: document.getElementById('check1').checked,
                moldCheck: document.getElementById('check2').checked,
                materialCheck: document.getElementById('check3').checked,
                safetyEquipmentCheck: document.getElementById('check4').checked,
                workAreaSafetyCheck: document.getElementById('check7').checked,
                workSpecificSafetyCheck: document.getElementById('check8').checked,
                instructionCheck: document.getElementById('check5').checked,
                handoverCheck: document.getElementById('check6').checked,
                checkTime: new Date(),
                checkedBy: currentWorker,
                workNo: selectedWork.name,
                isTwoPersonWork: isTwoPersonWork,
                participants: Utils.getWorkersInfo().all
            };
            
            Utils.hideModal('checklistModal');
            
            // 초품검사 모달 표시
            showFirstProductModal();
        }
        
        // 체크리스트 건너뛰기
        function skipChecklist() {
            if (Utils.confirm('점검을 건너뛰시겠습니까?\n안전을 위해 점검을 권장합니다.')) {
                startChecklist = {
                    skipped: true,
                    skipTime: new Date(),
                    skipBy: currentWorker
                };
                
                Utils.hideModal('checklistModal');
                
                // 초품검사 모달 표시
                showFirstProductModal();
            }
        }
        
        // 초품검사 모달 표시
        function showFirstProductModal() {
            Utils.showModal('firstProductModal');
            
            // 작업 정보 표시
            Utils.setElementText('inspectionWorkNo', selectedWork.name);
            Utils.setElementText('inspectionProduct', selectedWork.product);
            
            // 경고 영역 초기화
            Utils.setElementHtml('inspectionWarningArea', '');
            
            // 검사 그리드 생성
            generateInspectionGrid();
            
            // 진행률 초기화
            updateInspectionProgress();
        }
        
        // 검사 그리드 생성
        function generateInspectionGrid() {
            var grid = document.getElementById('inspectionGrid');
            grid.innerHTML = '';
            
            var criteria = productCriteria[selectedWork.product];
            if (!criteria) {
                Utils.showAlert('제품 검사 기준이 설정되지 않았습니다.');
                return;
            }
            
            // 초기화
            firstProductInspection = {
                products: [],
                startTime: new Date(),
                inspector: currentWorker,
                workNo: selectedWork.name,
                product: selectedWork.product,
                skipped: false,
                retryCount: inspectionRetryCount
            };
            
            // 불합격 상태 초기화
            hasFailedInspection = false;
            
            // 3개 제품 검사 카드 생성
            for (var i = 1; i <= CONFIG.INSPECTION_PRODUCTS_COUNT; i++) {
                var productCard = document.createElement('div');
                productCard.className = 'product-inspection';
                productCard.id = 'product' + i;
                
                productCard.innerHTML = `
                    <h4>제품 ${i}</h4>
                    <div class="inspection-items">
                        <div class="inspection-item">
                            <span class="inspection-label">길이</span>
                            <div class="inspection-buttons">
                                <button class="inspection-btn pass" onclick="setInspectionResult(${i}, 'length', 'pass')">합격</button>
                                <button class="inspection-btn fail" onclick="setInspectionResult(${i}, 'length', 'fail')">불합격</button>
                            </div>
                        </div>
                        <div class="inspection-item">
                            <span class="inspection-label">폭</span>
                            <div class="inspection-buttons">
                                <button class="inspection-btn pass" onclick="setInspectionResult(${i}, 'width', 'pass')">합격</button>
                                <button class="inspection-btn fail" onclick="setInspectionResult(${i}, 'width', 'fail')">불합격</button>
                            </div>
                        </div>
                        <div class="inspection-item">
                            <span class="inspection-label">가로굽힘</span>
                            <div class="inspection-buttons">
                                <button class="inspection-btn pass" onclick="setInspectionResult(${i}, 'bend', 'pass')">합격</button>
                                <button class="inspection-btn fail" onclick="setInspectionResult(${i}, 'bend', 'fail')">불합격</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-criteria">
                        <strong>검사기준:</strong><br>
                        길이: ${criteria.length.min}-${criteria.length.max}${criteria.length.unit}<br>
                        폭: ${criteria.width.min}-${criteria.width.max}${criteria.width.unit}<br>
                        가로굽힘: ≤${criteria.bend.max}${criteria.bend.unit}
                    </div>
                `;
                
                grid.appendChild(productCard);
                
                // 제품별 검사 결과 초기화
                firstProductInspection.products[i-1] = {
                    productNo: i,
                    length: null,
                    width: null,
                    bend: null,
                    overallResult: null
                };
            }
        }
        
        // 검사 결과 설정
        function setInspectionResult(productNo, item, result) {
            // 기존 선택 해제
            var productCard = document.getElementById('product' + productNo);
            var buttons = productCard.querySelectorAll('.inspection-item .inspection-btn');
            
            // 해당 항목의 버튼들에서 selected 클래스 제거
            var itemButtons = productCard.querySelectorAll('.inspection-item:nth-child(' + getItemIndex(item) + ') .inspection-btn');
            itemButtons.forEach(function(btn) {
                btn.classList.remove('selected');
            });
            
            // 선택된 버튼에 selected 클래스 추가
            event.target.classList.add('selected');
            
            // 결과 저장
            firstProductInspection.products[productNo-1][item] = result;
            
            // 불합격 즉시 반응
            if (result === 'fail') {
                hasFailedInspection = true;
                showInspectionWarning();
            }
            
            // 제품별 전체 결과 확인
            checkProductCompletion(productNo);
            
            // 전체 진행률 업데이트
            updateInspectionProgress();
        }
        
        // 검사 경고 표시
        function showInspectionWarning() {
            var warningArea = document.getElementById('inspectionWarningArea');
            if (hasFailedInspection) {
                warningArea.innerHTML = `
                    <div class="inspection-warning">
                        🚫 불합격 제품이 발견되었습니다!<br>
                        모든 검사 완료 후 설비 점검이 필요합니다.
                    </div>
                `;
            } else {
                warningArea.innerHTML = '';
            }
        }
        
        // 항목 인덱스 반환
        function getItemIndex(item) {
            switch(item) {
                case 'length': return 1;
                case 'width': return 2;
                case 'bend': return 3;
                default: return 1;
            }
        }
        
        // 제품 검사 완료 확인
        function checkProductCompletion(productNo) {
            var product = firstProductInspection.products[productNo-1];
            var productCard = document.getElementById('product' + productNo);
            
            // 모든 항목이 검사되었는지 확인
            if (product.length !== null && product.width !== null && product.bend !== null) {
                // 전체 결과 판정
                var hasFailure = product.length === 'fail' || product.width === 'fail' || product.bend === 'fail';
                product.overallResult = hasFailure ? 'fail' : 'pass';
                
                // 카드 스타일 변경
                productCard.classList.remove('completed', 'failed');
                if (hasFailure) {
                    productCard.classList.add('failed');
                } else {
                    productCard.classList.add('completed');
                }
            }
        }
        
        // 검사 진행률 업데이트
        function updateInspectionProgress() {
            var completedProducts = 0;
            
            for (var i = 0; i < CONFIG.INSPECTION_PRODUCTS_COUNT; i++) {
                var product = firstProductInspection.products[i];
                if (product.length !== null && product.width !== null && product.bend !== null) {
                    completedProducts++;
                }
            }
            
            Utils.setElementText('inspectionProgress', 
                '검사 진행률: ' + completedProducts + '/' + CONFIG.INSPECTION_PRODUCTS_COUNT + ' 완료');
            
            // 모든 검사 완료 시 버튼 활성화
            var completeBtn = document.getElementById('completeInspectionBtn');
            if (completedProducts === CONFIG.INSPECTION_PRODUCTS_COUNT) {
                completeBtn.disabled = false;
                if (hasFailedInspection) {
                    completeBtn.textContent = '❌ 검사 완료 (불합격 있음)';
                    completeBtn.style.background = '#ef4444';
                } else {
                    completeBtn.textContent = '✅ 검사 완료 - 작업 시작';
                    completeBtn.style.background = '#10b981';
                }
            } else {
                completeBtn.disabled = true;
                completeBtn.textContent = '✅ 검사 완료 - 작업 시작';
                completeBtn.style.background = '#6b7280';
            }
        }
        
        // 검사 완료
        function completeInspection() {
            // 불합격 제품 수 확인
            var failedProducts = firstProductInspection.products.filter(function(p) {
                return p.overallResult === 'fail';
            }).length;
            
            // 검사 완료 시간 기록
            firstProductInspection.endTime = new Date();
            firstProductInspection.failedCount = failedProducts;
            firstProductInspection.passedCount = CONFIG.INSPECTION_PRODUCTS_COUNT - failedProducts;
            firstProductInspection.retryCount = inspectionRetryCount;
            
            // 불합격이 하나라도 있는 경우
            if (failedProducts > 0) {
                Utils.hideModal('firstProductModal');
                showInspectionFailedModal(failedProducts);
                return;
            }
            
            // 모든 제품 합격 시
            Utils.showAlert('초품검사 완료!\n모든 제품이 합격하였습니다. 본생산을 시작합니다.');
            Utils.hideModal('firstProductModal');
            actualStartWork();
        }
        
        // 검사 실패 모달 표시
        function showInspectionFailedModal(failedCount) {
            var passedCount = CONFIG.INSPECTION_PRODUCTS_COUNT - failedCount;
            
            // 결과 텍스트 업데이트
            Utils.setElementText('failedResultText', 
                '합격 ' + passedCount + '개, 불합격 ' + failedCount + '개');
            
            // 재검사 횟수 표시
            if (inspectionRetryCount > 0) {
                document.getElementById('retryWarning').classList.remove('hidden');
                Utils.setElementText('retryCount', inspectionRetryCount);
            } else {
                document.getElementById('retryWarning').classList.add('hidden');
            }
            
            // 3회 초과 시 재검사 버튼 비활성화
            var retryBtn = document.querySelector('.btn-retry');
            if (inspectionRetryCount >= CONFIG.INSPECTION_MAX_RETRY_COUNT) {
                retryBtn.disabled = true;
                retryBtn.textContent = '❌ 재검사 불가 (관리자 호출 필요)';
                retryBtn.style.background = '#6b7280';
            } else {
                retryBtn.disabled = false;
                retryBtn.textContent = '🔄 재검사 실시';
                retryBtn.style.background = '#f59e0b';
            }
            
            Utils.showModal('inspectionFailedModal');
        }
        
        // 재검사 실시
        function retryInspection() {
            if (inspectionRetryCount >= CONFIG.INSPECTION_MAX_RETRY_COUNT) {
                Utils.showAlert('재검사 횟수가 초과되었습니다.\n관리자에게 문의하세요.');
                return;
            }
            
            inspectionRetryCount++;
            
            // 실패 모달 닫기
            Utils.hideModal('inspectionFailedModal');
            
            // 검사 데이터 초기화
            hasFailedInspection = false;
            
            // 검사 모달 다시 표시
            showFirstProductModal();
            
            Utils.showAlert('재검사를 시작합니다.\n새로운 3개 제품을 검사해주세요. (재검사 ' + inspectionRetryCount + '회차)');
        }
        
        // 설비점검 요청
        function requestMaintenance() {
            var maintenanceRequest = {
                time: new Date(),
                worker: currentWorker,
                machine: currentMachine,
                workNo: selectedWork.name,
                product: selectedWork.product,
                reason: '초품검사 불합격',
                failedCount: firstProductInspection.failedCount,
                retryCount: inspectionRetryCount,
                lotNumber: currentLotNumber,
                moldNumber: currentMoldNumber
            };
            
            // 실제로는 관리자 시스템에 알림 전송
            console.log('설비점검 요청:', maintenanceRequest);
            
            Utils.hideModal('inspectionFailedModal');
            
            Utils.showAlert('설비점검 요청이 전송되었습니다.\n관리자가 확인 후 조치할 예정입니다.\n\n요청 내용:\n- 호기: ' + currentMachine + '호기\n- 작업자: ' + currentWorker + 
                  '\n- 불합격 개수: ' + firstProductInspection.failedCount + '개\n- 재검사 횟수: ' + inspectionRetryCount + '회');
            
            // 작업 선택 해제 및 초기화
            selectedWork = null;
            Utils.setElementText('currentWork', '');
            Utils.setButtonState('startBtn', false);
            loadWorkList();
        }
        
        // 작업 시작 시 불량 알림 섹션 표시
        function actualStartWork() {
            workStartTime = new Date();
            workStatus = 'working';
            selectedWork.status = 'working';
            totalStopTime = 0;
            
            // 불량 알림 섹션 표시
            Utils.showElement('defectAlertSection');
            
            Utils.setButtonState('startBtn', false);
            Utils.setButtonState('stopBtn', true);
            Utils.setButtonState('resumeBtn', false);
            Utils.setButtonState('pauseBtn', true);
            Utils.setButtonState('endBtn', true);
            Utils.setButtonState('resumeWorkBtn', false);
            
            // 이전 생산량 표시
            if (selectedWork.actualQty > 0) {
                Utils.setElementText('previousProduction', 
                    '이전 생산량: ' + selectedWork.actualQty + 'm');
            }
            
            // LOT 및 금형 정보도 함께 표시
            var workInfo = '작업 중: ' + selectedWork.name;
            if (isTwoPersonWork) {
                workInfo += '<br><span style="font-size: 14px; color: #666;">참여자: ' + Utils.getWorkersInfo().display + '</span>';
            }
            workInfo += '<br><span style="font-size: 12px; color: #666;">LOT: ' + currentLotNumber + 
                       ' | 금형: ' + currentMoldNumber + '</span>';
            
            Utils.setElementHtml('currentWork', workInfo);
            
            var alertMsg = '작업을 시작합니다: ' + selectedWork.name + '\nLOT: ' + currentLotNumber + '\n금형: ' + currentMoldNumber;
            if (isTwoPersonWork) {
                alertMsg += '\n참여자: ' + Utils.getWorkersInfo().display;
            }
            // 초품검사 결과 요약 추가
            if (firstProductInspection.failedCount > 0) {
                alertMsg += '\n초품검사: 합격 ' + firstProductInspection.passedCount + '개, 불합격 ' + firstProductInspection.failedCount + '개';
            } else {
                alertMsg += '\n초품검사: 모든 제품 합격';
            }
            Utils.showAlert(alertMsg);
        }
        
        // 불량 상세 분석 모달 표시
        function showDefectAnalysisModal() {
            Utils.showModal('defectAnalysisModal');
            
            // 현재 작업 정보 자동 입력
            updateWorkContext();
            
            // 분석 단계 초기화
            resetAnalysisSteps();
            
            // 과거 유사 불량 검색
            searchSimilarDefects();
        }
        
        // 현재 작업 컨텍스트 정보 업데이트
        function updateWorkContext() {
            var now = new Date();
            
            if (selectedWork && workStatus === 'working') {
                Utils.setElementText('contextWorkNo', selectedWork.name);
                Utils.setElementText('contextProduct', selectedWork.product);
                Utils.setElementText('contextLot', currentLotNumber || '-');
                Utils.setElementText('contextMold', currentMoldNumber || '-');
                Utils.setElementText('contextWorkers', Utils.getWorkersInfo().display);
                
                if (workStartTime) {
                    var elapsed = Math.floor((now - workStartTime) / 1000 / 60);
                    Utils.setElementText('contextElapsed', elapsed + '분');
                    
                    var progress = selectedWork.actualQty + (selectedWork.correction ? selectedWork.correction.adjustedQty : 0);
                    var progressPercent = selectedWork.targetQty > 0 ? (progress / selectedWork.targetQty * 100).toFixed(1) : 0;
                    Utils.setElementText('contextProgress', progress + 'm (' + progressPercent + '%)');
                } else {
                    Utils.setElementText('contextElapsed', '-');
                    Utils.setElementText('contextProgress', '-');
                }
            } else {
                Utils.setElementText('contextWorkNo', '작업 중이 아님');
                Utils.setElementText('contextProduct', '-');
                Utils.setElementText('contextLot', '-');
                Utils.setElementText('contextMold', '-');
                Utils.setElementText('contextWorkers', currentWorker || '-');
                Utils.setElementText('contextElapsed', '-');
                Utils.setElementText('contextProgress', '-');
            }
            
            Utils.setElementText('contextTime', Utils.formatDateTime(now));
        }
        
        // 분석 단계 초기화
        function resetAnalysisSteps() {
            defectAnalysisStep = 1;
            selectedDefectType = '';
            selectedCause = '';
            
            // 모든 단계 비활성화
            for (var i = 1; i <= 4; i++) {
                var step = document.getElementById('step' + i);
                step.classList.remove('active', 'completed');
                if (i === 1) step.classList.add('active');
            }
            
            // 입력 필드 초기화
            Utils.setElementValue('analysisDefectQty', '');
            Utils.setElementValue('defectLocation', '');
            Utils.setElementValue('immediateAction', '');
            Utils.setElementValue('preventionPlan', '');
            Utils.setElementValue('actionOwner', currentWorker);
            
            // 내일 날짜로 기본 설정
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('actionDeadline').value = tomorrow.toISOString().split('T')[0];
        }
        
        // 불량 유형 선택
        function selectDefectType(type) {
            selectedDefectType = type;
            
            // 선택 표시
            document.querySelectorAll('.defect-type-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // 2단계 완료 표시
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            
            // 원인 분석 트리 생성
            generateCauseTree(type);
            
            defectAnalysisStep = 3;
        }
        
        // 원인 분석 트리 생성
        function generateCauseTree(defectType) {
            var tree = document.getElementById('causeTree');
            tree.innerHTML = '';
            
            var causes = defectCauses[defectType] || defectCauses['surface'];
            
            Object.keys(causes).forEach(function(category) {
                var categoryDiv = document.createElement('div');
                categoryDiv.className = 'cause-category';
                
                var header = document.createElement('div');
                header.className = 'cause-header';
                header.innerHTML = category + ' <span>▼</span>';
                header.onclick = function() {
                    var list = this.nextElementSibling;
                    list.classList.toggle('active');
                    this.querySelector('span').textContent = list.classList.contains('active') ? '▲' : '▼';
                };
                
                var list = document.createElement('div');
                list.className = 'cause-list';
                
                causes[category].forEach(function(cause) {
                    var item = document.createElement('div');
                    item.className = 'cause-item';
                    item.textContent = cause;
                    item.onclick = function() {
                        selectCause(category, cause, this);
                    };
                    list.appendChild(item);
                });
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(list);
                tree.appendChild(categoryDiv);
            });
        }
        
        // 원인 선택
        function selectCause(category, cause, element) {
            selectedCause = category + ' > ' + cause;
            
            // 선택 표시
            document.querySelectorAll('.cause-item').forEach(function(item) {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // 3단계 완료 표시
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step4').classList.add('active');
            
            // 불량 영향도 평가
            evaluateDefectImpact();
            
            defectAnalysisStep = 4;
        }
        
        // 불량 영향도 평가
        function evaluateDefectImpact() {
            var qty = parseFloat(Utils.getElementValue('analysisDefectQty')) || 0;
            var impactLevel = 'low';
            var message = '';
            
            // 수량 기반 영향도 평가
            if (qty >= 50) {
                impactLevel = 'high';
                message = '대량 불량 발생! 즉시 작업 중단 및 관리자 보고 필요';
            } else if (qty >= 20) {
                impactLevel = 'medium';
                message = '중간 규모 불량 발생. 원인 파악 및 조치 필요';
            } else if (qty > 0) {
                impactLevel = 'low';
                message = '소량 불량 발생. 모니터링 및 예방 조치 필요';
            }
            
            // 불량 유형별 가중치 적용
            if (selectedDefectType === 'dimension' || selectedDefectType === 'crack') {
                if (impactLevel === 'low') impactLevel = 'medium';
                else if (impactLevel === 'medium') impactLevel = 'high';
            }
            
            // 영향도 표시
            var alertDiv = document.getElementById('defectImpactAlert');
            var levelEl = document.getElementById('impactLevel');
            var messageEl = document.getElementById('impactMessage');
            
            levelEl.textContent = impactLevel === 'high' ? '높음' : impactLevel === 'medium' ? '보통' : '낮음';
            levelEl.className = 'impact-level ' + impactLevel;
            messageEl.textContent = message;
            Utils.showElement('defectImpactAlert');
        }
        
        // 과거 유사 불량 검색
        function searchSimilarDefects() {
            // 실제로는 데이터베이스에서 검색
            var similarDefects = [
                {
                    date: '2025-01-20',
                    workNo: '3-0120-01',
                    product: 'M-BAR-KS',
                    type: '표면불량',
                    cause: '롤러 표면 손상',
                    action: '롤러 교체',
                    status: 'resolved'
                },
                {
                    date: '2025-01-18',
                    workNo: '3-0118-02',
                    product: 'M-BAR-KS',
                    type: '표면불량',
                    cause: '윤활유 부족',
                    action: '윤활유 보충 및 점검 주기 단축',
                    status: 'resolved'
                }
            ];
            
            if (similarDefects.length > 0) {
                var historySection = document.getElementById('defectHistorySection');
                var historyDiv = document.getElementById('similarDefectHistory');
                
                historyDiv.innerHTML = '';
                similarDefects.forEach(function(defect) {
                    var item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-header">
                            <strong>${defect.date} - ${defect.workNo}</strong>
                            <span class="history-badge ${defect.status}">${defect.status === 'resolved' ? '해결됨' : '진행중'}</span>
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            불량: ${defect.type} | 원인: ${defect.cause}<br>
                            조치: ${defect.action}
                        </div>
                    `;
                    historyDiv.appendChild(item);
                });
                
                Utils.showElement('defectHistorySection');
            }
        }
        
        // 상세 불량 저장
        function saveDetailedDefect() {
            var qty = parseFloat(Utils.getElementValue('analysisDefectQty'));
            var location = Utils.getElementValue('defectLocation');
            var immediateAction = Utils.getElementValue('immediateAction');
            var preventionPlan = Utils.getElementValue('preventionPlan');
            var actionOwner = Utils.getElementValue('actionOwner');
            var actionDeadline = Utils.getElementValue('actionDeadline');
            
            if (!qty || qty <= 0) {
                Utils.showAlert('불량 수량을 입력하세요.');
                return;
            }
            
            if (!selectedDefectType) {
                Utils.showAlert('불량 유형을 선택하세요.');
                return;
            }
            
            if (!selectedCause) {
                Utils.showAlert('불량 원인을 선택하세요.');
                return;
            }
            
            if (!immediateAction.trim()) {
                Utils.showAlert('즉시 조치사항을 입력하세요.');
                return;
            }
            
            // 상세 불량 기록 생성
            var detailedDefect = {
                id: Date.now(),
                time: new Date(),
                qty: qty,
                location: location,
                type: selectedDefectType,
                typeText: DEFECT_TYPES[selectedDefectType] || selectedDefectType,
                cause: selectedCause,
                immediateAction: immediateAction,
                preventionPlan: preventionPlan,
                actionOwner: actionOwner,
                actionDeadline: actionDeadline,
                // 작업 컨텍스트
                workContext: {
                    workNo: selectedWork ? selectedWork.name : null,
                    product: selectedWork ? selectedWork.product : null,
                    customer: selectedWork ? selectedWork.customer : null,
                    lotNumber: currentLotNumber,
                    moldNumber: currentMoldNumber,
                    workers: Utils.getWorkersInfo().all,
                    workStartTime: workStartTime,
                    workElapsed: workStartTime ? Math.floor((new Date() - workStartTime) / 1000 / 60) : 0,
                    currentProgress: selectedWork ? selectedWork.actualQty : 0
                },
                status: 'active',
                reportedBy: currentWorker,
                machine: currentMachine
            };
            
            detailedDefectRecords.push(detailedDefect);
            
            // 일반 불량 기록에도 추가
            var simpleDefect = {
                time: Utils.formatTime(new Date()),
                qty: qty,
                type: selectedDefectType,
                typeText: DEFECT_TYPES[selectedDefectType] || selectedDefectType,
                workers: Utils.getWorkersInfo().all,
                machine: currentMachine,
                isDetailed: true,
                detailId: detailedDefect.id
            };
            
            defectRecords.push(simpleDefect);
            
            // 관리자 알림 (실제로는 Firebase/서버로 전송)
            var alertMessage = `🚨 상세 불량 분석 완료\n` +
                             `호기: ${currentMachine}호기\n` +
                             `작업: ${detailedDefect.workContext.workNo || '미지정'}\n` +
                             `불량: ${qty}m (${detailedDefect.typeText})\n` +
                             `원인: ${selectedCause}\n` +
                             `조치: ${immediateAction}`;
            
            console.log('관리자 알림:', alertMessage);
            
            // 실시간 토스트 알림
            showToast('error', '불량 신고 완료', 
                `${qty}m ${detailedDefect.typeText} 불량이 관리자에게 신고되었습니다.`);
            
            // 연속 불량 체크
            checkConsecutiveDefects();
            
            // UI 업데이트
            updateDefectList();
            updateKPI();
            
            Utils.hideModal('defectAnalysisModal');
            
            Utils.showAlert('상세 불량 분석이 완료되어 관리자에게 알림이 전송되었습니다.\n추적 ID: ' + detailedDefect.id);
        }
        
        // 연속 불량 체크
        function checkConsecutiveDefects() {
            var recentDefects = defectRecords.filter(function(d) {
                var defectTime = new Date(d.time);
                var now = new Date();
                var timeDiff = (now - defectTime) / 1000 / 60; // 분 단위
                return timeDiff <= CONFIG.DEFECT_CONSECUTIVE_TIME_MINUTES;
            });
            
            if (recentDefects.length >= CONFIG.DEFECT_CONSECUTIVE_COUNT_THRESHOLD) {
                showToast('error', '연속 불량 경고', 
                    '30분 내 3건 이상 불량 발생! 즉시 작업 중단 권고');
                
                // 작업 중단 권고 알림
                if (Utils.confirm('🚨 연속 불량이 발생했습니다.\n작업을 일시 중단하고 관리자에게 보고하시겠습니까?')) {
                    // 작업 일시 정지 로직
                    console.log('연속 불량으로 인한 작업 중단 요청');
                }
            }
        }
        
        // 불량 분석 모달 닫기
        function closeDefectAnalysisModal() {
            Utils.hideModal('defectAnalysisModal');
        }
        
        // 불량 상세 정보 보기
        function showDefectDetail(detailId) {
            var detailedRecord = detailedDefectRecords.find(function(d) { return d.id === detailId; });
            if (!detailedRecord) return;
            
            var detailInfo = `
🔍 불량 상세 분석 결과

📋 기본 정보:
- 추적 ID: ${detailedRecord.id}
- 발생 시간: ${Utils.formatDateTime(detailedRecord.time)}
- 불량 수량: ${detailedRecord.qty}m
- 발견 위치: ${detailedRecord.location || '-'}
- 불량 유형: ${detailedRecord.typeText}

🔧 작업 컨텍스트:
- 작업지시서: ${detailedRecord.workContext.workNo || '-'}
- 제품명: ${detailedRecord.workContext.product || '-'}
- LOT 번호: ${detailedRecord.workContext.lotNumber || '-'}
- 금형 번호: ${detailedRecord.workContext.moldNumber || '-'}
- 작업자: ${detailedRecord.workContext.workers.join(', ')}
- 작업 경과: ${detailedRecord.workContext.workElapsed}분

🎯 원인 분석:
- 원인: ${detailedRecord.cause}

⚡ 조치 사항:
- 즉시 조치: ${detailedRecord.immediateAction}
- 재발 방지: ${detailedRecord.preventionPlan || '-'}
- 담당자: ${detailedRecord.actionOwner}
- 완료 예정: ${detailedRecord.actionDeadline || '-'}

📊 상태: ${detailedRecord.status === 'active' ? '진행중' : '완료'}
신고자: ${detailedRecord.reportedBy} (${detailedRecord.machine}호기)
            `;
            
            Utils.showAlert(detailInfo);
        }
    </script>
</body>
</html>
